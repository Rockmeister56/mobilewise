<!DOCTYPE html>
<html lang="en">
<head>
    <script src="testimonials-data.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ Mobile-Wise AI Testimonial Manager PRO</title>
    <style>
        :root {
            --primary: #2196F3;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
            --dark: #1a1a2e;
            --darker: #16213e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #01020a;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--primary);
        }
        
        .sidebar h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        
        .industry-list {
            list-style: none;
            margin-bottom: 30px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .industry-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .industry-list::-webkit-scrollbar-track {
            background: rgb(0, 0, 0);
            border-radius: 3px;
        }
        
        .industry-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .industry-item {
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
        }
        
        .industry-item:hover {
            background: rgba(33, 150, 243, 0.2);
            transform: translateX(5px);
        }
        
        .industry-item.active {
            background: rgba(33, 150, 243, 0.3);
            border-left: 3px solid var(--primary);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary {
            background: var(--primary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .card {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid;
            margin-bottom: 20px;
        }
        
        .card.uploader {
            border-color: var(--primary);
        }
        
        .card.code {
            border-color: var(--success);
        }
        
        .upload-area {
            border: 3px dashed var(--primary);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            margin: 20px 0;
            background: rgba(33, 150, 243, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.05);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        .form-control::placeholder {
            color: #888;
        }
        
        .code-editor {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #d4d4d4;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
            line-height: 1.5;
        }

        /* Add to your CSS file */
.testimonial-type-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.testimonial-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.recent-testimonial-item {
    transition: background-color 0.2s;
}

.recent-testimonial-item:hover {
    background-color: #f8f9fa;
}

#recentTestimonialsList::-webkit-scrollbar {
    width: 6px;
}

#recentTestimonialsList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#recentTestimonialsList::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#recentTestimonialsList::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

        /* =================================================== */
/* TRIGGER SYSTEM STYLES */
/* =================================================== */

.trigger-type-btn {
    flex: 1;
    padding: 8px 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.trigger-type-btn:hover {
    background: rgba(255,255,255,0.1);
}

.trigger-type-btn.active {
    background: var(--primary);
    border-color: var(--primary);
}

.trigger-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    gap: 10px;
}

.dropdown-item:hover {
    background: rgba(255,255,255,0.05);
}

.trigger-preview {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
}
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .status-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .status-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        .video-preview-container {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .video-preview-container video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .video-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
            border: 1px solid var(--success);
        }
        
        .video-info code {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #4CAF50;
        }
        
        .help-box {
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            border: 1px solid #FF9800;
        }
        
        .help-box h4 {
            color: #FF9800;
            margin-bottom: 10px;
        }
        
        .help-box ol {
            margin-left: 20px;
            color: #ccc;
            line-height: 1.6;
        }
        
        .help-box li {
            margin-bottom: 8px;
        }
        
        .help-box code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #FF9800;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .url-input-group .form-control {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--primary);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .url-input-group {
                flex-direction: column;
            }
        }
        /* Add to your existing CSS */
.form-group {
    margin-bottom: 20px;
}

.search-wrapper {
    position: relative;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.dropdown-item:hover {
    background-color: #f5f5f5;
}

.trigger-phrases-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.phrase-tag {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
    color: #495057;
}

.phrase-tag.selectable {
    cursor: pointer;
    transition: background-color 0.2s;
}

.phrase-tag.selectable:hover {
    background: #007bff;
    color: white;
}

.concern-option {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 8px;
    background: #f9f9f9;
}

.concern-icon {
    font-size: 20px;
    margin-right: 10px;
}

.concern-title {
    font-weight: 500;
    flex-grow: 1;
}

.trigger-phrases-preview {
    margin-left: 10px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.phrase-more {
    color: #6c757d;
    font-size: 12px;
    font-style: italic;
}

/* Syntax highlighting for code preview */
.comment {
    color: #6a9955;
}

.string {
    color: #ce9178;
}

.keyword {
    color: #569cd6;
    font-weight: bold;
}

        /* Add to your existing CSS */
html {
    scroll-behavior: auto !important; /* Disable smooth scrolling */
}

button, input[type="button"], input[type="submit"] {
    outline: none !important;
}

button:focus, input:focus {
    outline: 2px solid #4CAF50 !important; /* Better than default */
    outline-offset: 2px !important;
}

/* Prevent hash/anchor jumps */
:target {
    scroll-margin-top: 20px; /* Add some space */
}

/* Fix form submissions */
form {
    overflow-anchor: none; /* Prevents scroll anchoring */
}

/* If using anchor links */
a[href^="#"] {
    scroll-behavior: auto;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <h2>üè¢ Industries</h2>
            <ul class="industry-list" id="industryList">
                <!-- Industries loaded here -->
            </ul>
            
            <button class="btn btn-success" onclick="showAddIndustryModal()" style="width: 100%;">
                ‚ûï Add Industry
            </button>
            
            <div style="margin-top: 30px;">
                <h3>üìä Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statIndustries">0</div>
                        <div class="stat-label">Industries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statVideos">0</div>
                        <div class="stat-label">Videos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statConcerns">0</div>
                        <div class="stat-label">Concerns</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTestimonials">0</div>
                        <div class="stat-label">Testimonials</div>
                    </div>
                </div>
            </div>

            <!-- UPDATED SIDEBAR CODE - DARK THEME -->
<div style="margin-top: 30px; padding: 15px; border-radius: 8px;">

    <!-- CLEAN INDUSTRY HEADER -->
<div style="display: none;">
    <!-- These elements MUST exist for JavaScript to work -->
    <div id="industryIconDisplay">üè¢</div>
    <div id="currentIndustryName">None selected</div>
</div>
    
    <!-- TESTIMONIALS OVERVIEW -->
<div id="testimonialsOverview" style="background: transparent; padding: 0; margin-bottom: 25px;">
    
    <!-- TESTIMONIAL CARDS (Rectangular, vertical layout) -->
    <div id="testimonialCardsContainer" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px;">
        <!-- Cards will be dynamically inserted here -->
        <div class="testimonial-card-empty" style="text-align: center; padding: 20px; background: rgba(33,37,41,0.3); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.1); color: #6c757d;">
            <div style="font-size: 24px; margin-bottom: 8px;">üé¨</div>
            <div>No testimonials yet</div>
            <div style="font-size: 12px; margin-top: 5px;">Add your first testimonial</div>
        </div>
    </div>
    
    <!-- VIEW ALL BUTTON -->
    <button class="btn" onclick="showAllTestimonialsModal()" 
            style="width: 100%; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.3)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
        <span style="font-size: 16px; margin-right: 8px;">üëÅÔ∏è</span>
        View All Testimonials
    </button>
</div>

<!-- VIEW ALL TESTIMONIALS MODAL -->
<div id="allTestimonialsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto;">
    <div class="modal-content" style="background: #1a1d21; max-width: 900px; margin: 40px auto; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between;">
            <h2 style="margin: 0; color: #e9ecef; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üé¨</span>
                <span>All Testimonials</span>
                <span id="totalTestimonialsCount" style="background: #007bff; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">0</span>
            </h2>
            <button class="close-modal" onclick="hideAllTestimonialsModal()" 
                    style="background: transparent; border: none; color: #adb5bd; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='white';">
                √ó
            </button>
        </div>
        
        <div class="modal-body" style="padding: 0;">
            <!-- FILTERS -->
            <div style="padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="testimonialFilterIndustry" style="flex: 1; min-width: 200px; padding: 10px; background: rgba(33,37,41,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #e9ecef;">
                        <option value="">All Industries</option>
                    </select>
                    <select id="testimonialFilterType" style="flex: 1; min-width: 200px; padding: 10px; background: rgba(33,37,41,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #e9ecef;">
                        <option value="">All Concern Types</option>
                        <option value="price">üí∞ Price</option>
                        <option value="time">‚è∞ Time</option>
                        <option value="trust">ü§ù Trust</option>
                        <option value="results">üìà Results</option>
                    </select>
                    <button onclick="filterTestimonials()" 
                            style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        üîç Filter
                    </button>
                    <button onclick="resetTestimonialFilters()" 
                            style="padding: 10px 20px; background: transparent; color: #adb5bd; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer;">
                        ‚Üª Reset
                    </button>
                </div>
            </div>
            
            <!-- TESTIMONIALS GRID -->
            <div id="allTestimonialsGrid" style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; max-height: 500px; overflow-y: auto;">
                <!-- Testimonials will be dynamically inserted here -->
                <div class="testimonial-empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üé¨</div>
                    <h3 style="color: #adb5bd;">No testimonials found</h3>
                    <p>Add testimonials to see them here</p>
                </div>
            </div>
            
            <!-- VIDEO PLAYER MODAL -->
            <div id="videoPlayerModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; align-items: center; justify-content: center;">
                <div style="background: #1a1d21; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between;">
                        <h3 id="videoPlayerTitle" style="margin: 0; color: #e9ecef;">Video Testimonial</h3>
                        <button onclick="hideVideoPlayer()" 
                                style="background: transparent; border: none; color: #adb5bd; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                            √ó
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <video id="testimonialVideoPlayer" controls style="width: 100%; border-radius: 8px; background: black;">
                            Your browser does not support the video tag.
                        </video>
                        <div id="videoPlayerInfo" style="margin-top: 15px; color: #adb5bd; font-size: 14px;">
                            <div><strong>Author:</strong> <span id="videoAuthor">Unknown</span></div>
                            <div><strong>Concern:</strong> <span id="videoConcern">General</span></div>
                            <div><strong>Industry:</strong> <span id="videoIndustry">General Business</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

   <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="saveAllData()" style="width: 100%; margin-bottom: 10px;">
                    üíæ Save All Changes
                </button>
                <button class="btn btn-warning" onclick="downloadJSFile()" style="width: 100%; margin-bottom: 10px;">
                    üì§ Download JS File
                </button>
                <button class="btn" onclick="loadSampleData()" style="background: #9C27B0; width: 100%;">
                    üéØ Load Sample Data
                </button>
            </div>
        </div>
        
        <!-- QUICK ACTIONS -->
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="showAddVideoModal()" 
                    style="flex: 1; background: #17a2b8; color: white; padding: 8px; font-size: 12px;">
                üé¨ Add Video
            </button>
            <button class="btn" onclick="showAddTextModal()" 
                    style="flex: 1; background: #6c757d; color: white; padding: 8px; font-size: 12px;">
                üìù Add Text
            </button>
        </div>
    </div>
        
        <!-- MAIN CONTENT -->
        <div style="flex: 1;">
            <!-- UPLOADER CARD -->
            <div class="card uploader">
                <h2>üé¨ Add Video Testimonial</h2>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Current Industry: <strong id="currentIndustryName" style="color: var(--primary);">None selected</strong>
                </p>
                
                <!-- INDUSTRY SELECTION (if not already selected) -->
                <div class="form-group" id="industrySelectGroup" style="display: none;">
                    <label>Select Industry</label>
                    <select class="form-control" id="selectIndustryDropdown">
                        <option value="">-- Select Industry --</option>
                    </select>
                </div>
                
            
<!-- =================================================== -->
<!-- ENHANCED TRIGGER SELECTION SYSTEM -->
<!-- =================================================== -->
<div class="form-group">
    <label>Trigger Type</label>
    <div class="btn-group" style="display: flex; gap: 5px; margin-bottom: 10px;">
        <button type="button" class="trigger-type-btn active" data-type="all">All</button>
        <button type="button" class="trigger-type-btn" data-type="negative">‚ùå Negative</button>
        <button type="button" class="trigger-type-btn" data-type="positive">‚úÖ Positive</button>
        <button type="button" class="trigger-type-btn" data-type="comparison">ü§î Comparison</button>
        <button type="button" class="trigger-type-btn" data-type="how-to">üîç How-To</button>
    </div>
    
    <div style="position: relative;">
        <input type="text" class="form-control" id="triggerSearch" 
               placeholder="Search triggers (e.g., 'forms', 'cost', 'benefits', 'how to')">
        <div id="triggerDropdown" class="trigger-dropdown">
            <!-- Triggers will load here -->
        </div>
    </div>
    
    <small style="color: #888; font-size: 12px;">
        Search triggers or type custom name below
    </small>
</div>

<div class="form-group">
    <label>Custom Trigger Name</label>
    <input type="text" class="form-control" id="concernName" 
           placeholder="e.g., forms-pain, pre-qual-benefits, case-value">
    <small style="color: #888; font-size: 12px;">
        Internal name (use hyphens, no spaces)
    </small>
</div>

<div class="form-group">
    <label>Trigger Display Title</label>
    <input type="text" class="form-control" id="concernTitle" 
           placeholder="e.g., Tired of Lengthy Forms?, Benefits of Pre-Qualification">
</div>

<div class="form-group">
    <label>Trigger Phrases (Keywords)</label>
    <textarea class="form-control" id="concernKeywords" rows="3"
              placeholder="too much paperwork, complicated forms, application nightmare, document overload"></textarea>
    <small style="color: #888; font-size: 12px;">
        Comma-separated phrases people might use
    </small>
</div>

<div id="triggerPreview" class="trigger-preview" style="display: none;">
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <span id="previewIcon" style="font-size: 24px;"></span>
        <div>
            <strong id="previewTitle"></strong>
            <div id="previewType" style="font-size: 12px; color: #888;"></div>
        </div>
    </div>
    <div style="font-size: 13px;">
        <strong>Trigger Phrases:</strong>
        <div id="previewPhrases" style="color: #ccc; margin-top: 5px;"></div>
    </div>
</div>
                
                <div class="form-group">
                    <label>Concern Display Title</label>
                    <input type="text" class="form-control" id="concernTitle" 
                           placeholder="e.g., From Intake to High-Value Case">
                </div>
                
                <div class="form-group">
                    <label>Icon Emoji</label>
                    <input type="text" class="form-control" id="concernIcon" 
                           placeholder="üéØ" value="üéØ">
                </div>
                
                <!-- VIDEO URL SECTION -->
                <div class="form-group">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Supabase Video URL</span>
                        <button type="button" class="btn btn-primary" onclick="openSupabaseUploader()" 
                                style="padding: 8px 12px; font-size: 12px;">
                            üì§ Open Supabase Uploader
                        </button>
                    </label>
                    <div class="url-input-group">
                        <input type="text" class="form-control" id="videoUrl" 
                               placeholder="https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/your-video.mp4"
                               style="font-family: monospace; font-size: 13px;">
                        <button type="button" class="btn btn-success" onclick="testVideoUrl()" 
                                style="padding: 12px 15px; white-space: nowrap;">
                            üîç Test URL
                        </button>
                    </div>
                    <small style="color: #888; font-size: 12px;">
                        Paste your Supabase public URL here. The system will extract the video key automatically.
                    </small>
                </div>
                
                <!-- VIDEO PREVIEW -->
                <div class="video-preview-container" id="videoPreview">
                    <h4 style="color: var(--success); margin-bottom: 10px;">‚úÖ Video Preview</h4>
                    <video id="previewVideo" controls></video>
                    <div class="video-info">
                        <div>Video Key: <code id="videoKeyDisplay"></code></div>
                        <div>Status: <span id="videoStatus" style="color: var(--success);">Ready to add</span></div>
                    </div>
                </div>
                
                <!-- TEXT TESTIMONIALS (OPTIONAL) -->
                <div class="form-group">
                    <label>Text Testimonial (Optional)</label>
                    <textarea class="form-control" id="textTestimonial" rows="3"
                              placeholder="e.g., 'This system saved us 15 hours per week...'"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Author Name</label>
                    <input type="text" class="form-control" id="authorName" 
                           placeholder="e.g., John D., Attorney">
                </div>
                
                <!-- ACTION BUTTONS -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="addVideoTestimonial()">
                        ‚úÖ Add Video Testimonial
                    </button>
                    <button class="btn btn-primary" onclick="addTextOnlyTestimonial()">
                        üí¨ Add Text Only
                    </button>
                </div>
                
                <!-- QUICK HELP -->
                <div class="help-box">
                    <h4>üí° Quick Instructions:</h4>
                    <ol>
                        <li>Select an industry from the sidebar first</li>
                        <li>Click "Open Supabase Uploader" to upload your video</li>
                        <li>Copy the public URL from Supabase</li>
                        <li>Paste it in the URL field and click "Test URL"</li>
                        <li>Fill in concern details (name, title, icon)</li>
                        <li>Optionally add text testimonial</li>
                        <li>Click "Add Video Testimonial" or "Add Text Only"</li>
                    </ol>
                </div>
            </div>
            
            <!-- CODE GENERATOR CARD -->
            <div class="card code">
                <h2>üë®‚Äçüíª Generated testimonials-data.js</h2>
                
                <div class="code-editor" id="codeOutput">
// Loading testimonial data...
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyCode()">
                        üìã Copy Code
                    </button>
                    <button class="btn btn-success" onclick="downloadJSFile()">
                        üíæ Download JS File
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADD INDUSTRY MODAL -->
    <div class="modal" id="addIndustryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè¢ Add New Industry</h2>
                <button class="close-modal" onclick="hideAddIndustryModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>Industry Name</label>
                <input type="text" class="form-control" id="newIndustryName" 
                       placeholder="e.g., Personal Injury Attorneys">
            </div>
            
            <div class="form-group">
                <label>Industry Slug (URL-friendly)</label>
                <input type="text" class="form-control" id="newIndustrySlug" 
                       placeholder="e.g., personal-injury">
                <small style="color: #888; font-size: 12px;">Use lowercase with hyphens (no spaces)</small>
            </div>
            
            <div class="form-group">
                <label>Icon Emoji</label>
                <input type="text" class="form-control" id="newIndustryIcon" 
                       placeholder="‚öñÔ∏è" value="üè¢">
            </div>
            
            <div class="form-group">
                <label>Keywords (comma-separated)</label>
                <textarea class="form-control" id="newIndustryKeywords" rows="3"
                          placeholder="attorney, lawyer, accident, injury, legal"></textarea>
                <small style="color: #888; font-size: 12px;">Used by AI to detect this industry</small>
            </div>
            
            <div class="action-buttons">
    <button class="btn btn-success" onclick="addIndustry()">
        ‚úÖ Add Industry
    </button>
    <button class="btn" onclick="hideAddIndustryModal()" style="background: #666;">
        Cancel
    </button>
</div>
<!-- Industry Selection -->
<div class="form-group">
    <label for="industry-select">Select Industry:</label>
    <select id="industry-select" class="form-control">
        <option value="general">üè¢ General Business</option>
        <!-- Options will be populated by JavaScript -->
    </select>
</div>

<!-- Concerns Checkboxes -->
<div class="form-group">
    <label>Select Concerns/Objections:</label>
    <div id="concerns-container" class="concerns-grid">
        <!-- Concerns will be populated by JavaScript -->
    </div>
</div>

<!-- Trigger Phrase Search -->
<div class="form-group">
    <label for="trigger-search">Trigger Phrase:</label>
    <input type="text" 
           id="trigger-search" 
           class="form-control" 
           placeholder="Search or select a trigger phrase..."
           autocomplete="off">
    <div id="trigger-dropdown" class="trigger-dropdown">
        <!-- Trigger phrases will appear here -->
    </div>
</div>

                </button>
            </div>
        </div>
    </div>
    
    <!-- STATUS MESSAGES -->
    <div class="status-message" id="successMessage"></div>
    <div class="status-message" id="errorMessage"></div>
    <div class="status-message" id="warningMessage"></div>

    <script>

        // ADD THIS FUNCTION AT THE TOP OF YOUR SCRIPT FILE:
function safeParsePhrases(jsonString) {
    if (!jsonString) return [];
    
    try {
        // Try normal parse first
        return JSON.parse(jsonString);
    } catch (error) {
        console.log('JSON parse failed, attempting recovery...');
        
        // If string appears to be truncated
        if (jsonString.includes('[') && !jsonString.includes(']')) {
            // Try to complete the JSON
            let fixed = jsonString;
            
            // Add missing closing bracket
            if (!fixed.endsWith(']')) {
                // Check if we need to close a string
                const quoteCount = (fixed.match(/"/g) || []).length;
                if (quoteCount % 2 === 1) {
                    fixed += '"';
                }
                fixed += ']';
            }
            
            try {
                return JSON.parse(fixed);
            } catch (e) {
                // Extract strings between quotes as last resort
                const matches = fixed.match(/"([^"]+)"/g) || [];
                return matches.map(m => m.slice(1, -1));
            }
        }
        
        // If no opening bracket, try to extract phrases
        const matches = jsonString.match(/"([^"]+)"/g) || jsonString.match(/'([^']+)'/g) || [];
        return matches.map(m => m.slice(1, -1));
    }
}

// ===================================================
// CRITICAL FIX: PRESERVE ORIGINAL FUNCTIONS
// ===================================================

// Save original functions BEFORE they get overwritten
window._originalTestimonialData = window.testimonialData;

// Function to ensure critical functions exist
function ensureTestimonialFunctions() {
    console.log('üîß Ensuring testimonial functions exist...');
    
    if (!window.testimonialData) {
        window.testimonialData = {};
    }
    
    // List of critical functions that MUST exist
    const criticalFunctions = {
        getAllIndustries: function() {
            console.log('üè≠ getAllIndustries called');
            // Return industries from management system OR empty array
            const industries = this.industries || {};
            const industryList = [];
            
            for (const [slug, data] of Object.entries(industries)) {
                industryList.push({
                    slug: slug,
                    name: data.name || slug,
                    icon: data.icon || 'üè¢'
                });
            }
            
            // Always include "general" as first option
            industryList.unshift({
                slug: 'general',
                name: 'General Business',
                icon: 'üè¢'
            });
            
            console.log(`   Found ${industryList.length} industries`);
            return industryList;
        },
        
        getIndustryTestimonials: function(industrySlug) {
            console.log('üéØ getIndustryTestimonials called for:', industrySlug);
            
            if (this.industries && this.industries[industrySlug]) {
                return {
                    industry: this.industries[industrySlug].name,
                    icon: this.industries[industrySlug].icon,
                    concerns: this.universalConcerns || {}
                };
            }
            
            // Fallback to universal concerns
            return {
                industry: 'General Business',
                icon: 'üè¢',
                concerns: this.universalConcerns || {}
            };
        },
        
        getIndustry: function(slug) {
            return this.industries ? this.industries[slug] || null : null;
        }
    };
    
    // Add missing functions
    Object.entries(criticalFunctions).forEach(([funcName, funcImpl]) => {
        if (!window.testimonialData[funcName] || typeof window.testimonialData[funcName] !== 'function') {
            window.testimonialData[funcName] = funcImpl.bind(window.testimonialData);
            console.log(`‚úÖ Added function: ${funcName}`);
        }
    });
    
    // Also copy any original functions that exist
    if (window._originalTestimonialData) {
        Object.keys(window._originalTestimonialData).forEach(key => {
            if (typeof window._originalTestimonialData[key] === 'function' && 
                !window.testimonialData[key]) {
                window.testimonialData[key] = window._originalTestimonialData[key];
                console.log(`üìã Copied original function: ${key}`);
            }
        });
    }
    
    console.log('üîß Available functions:', 
        Object.keys(window.testimonialData)
            .filter(k => typeof window.testimonialData[k] === 'function'));
}

// Run this early
ensureTestimonialFunctions();
        
// ===================================================
// LOAD CHECKER - Add this at the TOP of your script
// ===================================================
console.log('üîç Checking script loading...');

// Check if testimonials-data.js is loaded
if (typeof window.testimonialData === 'undefined') {
    console.log('üîç testimonials-data.js not loaded, checking localStorage...');
    
    // Try to load from localStorage FIRST
    const saved = localStorage.getItem('testimonialData');
    if (saved) {
        try {
            const savedData = JSON.parse(saved);
            
            // Only use localStorage data if it has industries
            if (savedData.industries && Object.keys(savedData.industries).length > 0) {
                window.testimonialData = savedData;
                console.log('‚úÖ Loaded testimonialData from localStorage');
                console.log('   Industries:', Object.keys(savedData.industries));
            } else {
                // Empty localStorage, wait for file to load
                console.log('‚ö†Ô∏è localStorage empty, creating temporary structure');
                window.testimonialData = {
                    concerns: {
                        price: { title: 'Price', icon: 'üí∞', videoType: 'skeptical', phrases: [] },
                        time: { title: 'Time', icon: '‚è∞', videoType: 'speed', phrases: [] },
                        trust: { title: 'Trust', icon: 'ü§ù', videoType: 'skeptical', phrases: [] }
                    },
                    industries: {},
                    playerConfig: {}
                };
            }
        } catch (e) {
            console.log('‚ùå Error loading from localStorage:', e);
            window.testimonialData = {
                concerns: {
                    price: { title: 'Price', icon: 'üí∞', videoType: 'skeptical', phrases: [] },
                    time: { title: 'Time', icon: '‚è∞', videoType: 'speed', phrases: [] },
                    trust: { title: 'Trust', icon: 'ü§ù', videoType: 'skeptical', phrases: [] }
                },
                industries: {},
                playerConfig: {}
            };
        }
    } else {
        console.log('‚ö†Ô∏è No saved data, creating temporary structure');
        window.testimonialData = {
            concerns: {
                price: { title: 'Price', icon: 'üí∞', videoType: 'skeptical', phrases: [] },
                time: { title: 'Time', icon: '‚è∞', videoType: 'speed', phrases: [] },
                trust: { title: 'Trust', icon: 'ü§ù', videoType: 'skeptical', phrases: [] }
            },
            industries: {},
            playerConfig: {}
        };
    };
}

        // ===================================================
        // CORE DATA & STATE
        // ===================================================
        let currentData = {
            industries: {},
            videos: {},
            industryKeywords: {},
            universalConcerns: {
                price: { 
                    title: 'See The ROI Others Achieved', 
                    icon: 'üí∞', 
                    videoType: 'universal-price', 
                    reviews: [
                        { text: "Paid for itself in the first 45 days", author: "Multiple Clients" },
                        { text: "Best marketing investment we made", author: "Industry Leaders" }
                    ] 
                },
                time: { 
                    title: 'For Busy Professionals', 
                    icon: '‚è∞', 
                    videoType: 'universal-time', 
                    reviews: [
                        { text: "Saved our team 25 hours/week", author: "Office Managers" },
                        { text: "Now handling 3x more leads", author: "Sales Directors" }
                    ] 
                },
                trust: { 
                    title: 'Proven Across Industries', 
                    icon: 'ü§ù', 
                    videoType: 'universal-trust', 
                    reviews: [
                        { text: "Worked exactly as promised", author: "Skeptical Buyers" },
                        { text: "Transformed how we handle leads", author: "Long-Term Clients" }
                    ] 
                }
            },
            playerConfig: {
                desktop: { width: 854, height: 480, top: '50%', left: '50%', borderRadius: '12px' },
                mobile: { fullscreen: true },
                overlay: { background: 'rgba(0, 0, 0, 0.5)' },
                resumeMessage: "I'm sure you can appreciate what similar businesses have achieved. Would you like to see how we can specifically help [Industry] like yours?"
            }
        };
        
        let currentIndustry = null;
        let currentVideoKey = null;

        function editCurrentIndustry() {
    if (!currentIndustry) {
        showMessage('Please select an industry first', 'error');
        return;
    }
    
    editIndustry(currentIndustry);
}

// ===================================================
// COMPLETE TRIGGER MANAGEMENT SYSTEM
// ===================================================

// 1. TRIGGER TEMPLATES DATABASE
const triggerTemplates = {
    // UNIVERSAL TRIGGERS (All industries)
    'universal': {
        'price-negative': {
            type: 'negative',
            title: 'Cost Concerns',
            icon: 'üí∞',
            phrases: ['expensive', 'cost', 'price', 'affordable', 'budget', 'investment', 'value', 'worth it'],
            defaultResponse: "I understand cost is important. Let me show you the value our clients received..."
        },
        'time-negative': {
            type: 'negative',
            title: 'Time/Speed Concerns',
            icon: '‚è∞',
            phrases: ['time', 'busy', 'quick', 'fast', 'speed', 'how long', 'schedule', 'hours'],
            defaultResponse: "I know your time is valuable. Here's how quickly our clients saw results..."
        },
        'trust-negative': {
            type: 'negative',
            title: 'Trust/Reliability',
            icon: 'ü§ù',
            phrases: ['trust', 'reliable', 'legit', 'proven', 'results', 'reviews', 'testimonials'],
            defaultResponse: "Trust is earned. Let me show you what our actual clients have to say..."
        },
        'benefits-positive': {
            type: 'positive',
            title: 'Benefits/Advantages',
            icon: '‚úÖ',
            phrases: ['benefits', 'advantages', 'why choose', 'better than', 'improve', 'help'],
            defaultResponse: "Great question! Here are the benefits our clients experienced..."
        },
        'how-to-positive': {
            type: 'how-to',
            title: 'How It Works',
            icon: 'üîç',
            phrases: ['how does it work', 'process', 'steps', 'what to expect', 'how to'],
            defaultResponse: "Let me walk you through the process our clients found so effective..."
        }
    },
    
    // PERSONAL INJURY SPECIFIC
    'personal-injury': {
        'forms-vs-interview': {
            type: 'comparison',
            title: 'Forms vs. Personal Interview',
            icon: 'üìã',
            phrases: [
                'forms vs interview', 'online forms better',
                'why not just forms', 'automated screening',
                'pre-qualification forms', 'digital intake'
            ],
            defaultResponse: "That's a smart comparison! Here's why our clients prefer the personal touch..."
        },
        'case-value': {
            type: 'positive',
            title: 'Case Value Assessment',
            icon: '‚öñÔ∏è',
            phrases: [
                'what is my case worth', 'settlement value',
                'compensation estimate', 'how much can I get',
                'payout amount', 'damages calculation'
            ],
            defaultResponse: "Understanding case value is crucial. Here's how we helped clients maximize theirs..."
        }
    },
    
    // MORTGAGE LENDING SPECIFIC
    'mortgage-lenders': {
        'forms-pain': {
            type: 'negative',
            title: 'Paperwork Frustration',
            icon: 'üò´',
            phrases: [
                'too much paperwork', 'complicated forms',
                'application nightmare', 'document overload',
                'forms frustrating', 'paperwork headache'
            ],
            defaultResponse: "Paperwork frustration is real! Here's how we simplified it for our clients..."
        },
        'pre-qual-benefits': {
            type: 'positive',
            title: 'Pre-Qualification Benefits',
            icon: 'üéØ',
            phrases: [
                'benefits of pre-qual', 'why pre-qualify',
                'pre-qual advantages', 'better than forms',
                'interview benefits', 'personal assessment'
            ],
            defaultResponse: "Pre-qualification has huge benefits! Here's what our clients loved about it..."
        },
        'rate-inquiry': {
            type: 'positive',
            title: 'Rate Questions',
            icon: 'üìâ',
            phrases: [
                'what rates', 'interest rates',
                'best rate', 'lowest rate',
                'rate comparison', 'competitive rates'
            ],
            defaultResponse: "Rates are important! Here's how our clients found our rates competitive..."
        }
    },
    
    // DENTAL SPECIFIC
    'dentists': {
        'emergency-concern': {
            type: 'negative',
            title: 'Dental Emergency',
            icon: 'üö®',
            phrases: [
                'dental emergency', 'tooth pain', 'urgent care',
                'broken tooth', 'severe pain', 'need help now'
            ],
            defaultResponse: "Dental emergencies are stressful! Here's how we helped clients in urgent situations..."
        },
        'cost-transparency': {
            type: 'positive',
            title: 'Cost Transparency',
            icon: 'üí∞',
            phrases: [
                'cost upfront', 'clear pricing',
                'no hidden fees', 'treatment cost',
                'insurance coverage', 'payment options'
            ],
            defaultResponse: "Cost transparency matters! Here's how our clients appreciated our clear pricing..."
        }
    }
    // Add more industries as needed...
};

 function deleteCurrentIndustry() {
    console.log('üéØ DELETE FUNCTION CALLED - currentIndustry:', currentIndustry);
    
    // üéØ FIX: Check if industry exists
    if (!currentIndustry) {
        showMessage('No industry selected', 'error');
        return;
    }
    
    // üéØ FIX: Check if industry still exists in data
    if (!currentData.industries || !currentData.industries[currentIndustry]) {
        console.log('‚ö†Ô∏è Industry not found in data:', currentIndustry);
        showMessage('Industry not found or already deleted', 'error');
        
        // Auto-select first available
        if (Object.keys(currentData.industries || {}).length > 0) {
            const firstIndustry = Object.keys(currentData.industries)[0];
            selectIndustry(firstIndustry);
        }
        return;
    }
    
    const industryName = currentData.industries[currentIndustry].name;
    
    if (!confirm(`‚ö†Ô∏è DELETE "${industryName}"?\n\nThis will remove:\n‚Ä¢ The industry\n‚Ä¢ All its concerns\n‚Ä¢ All testimonials\n‚Ä¢ Associated keywords\n\nThis cannot be undone!`)) {
        return;
    }
    
    console.log('üóëÔ∏è Proceeding with delete of:', industryName);
    
    // Delete industry
    delete currentData.industries[currentIndustry];
    if (currentData.industryKeywords) {
        delete currentData.industryKeywords[currentIndustry];
    }
    
    // Also delete any videos that start with this industry slug
    Object.keys(currentData.videos || {}).forEach(videoKey => {
        if (videoKey.startsWith(currentIndustry + '-')) {
            delete currentData.videos[videoKey];
        }
    });
    
    // Store the slug before clearing
    const deletedSlug = currentIndustry;
    currentIndustry = null;
    document.getElementById('currentIndustryName').textContent = 'None selected';
    
    updateIndustryList();
    updateStats();
    updateCodePreview();
    saveAllData();

    // üéØ CRITICAL FIX: Also update window.testimonialData
    if (window.testimonialData && window.testimonialData.industries) {
        delete window.testimonialData.industries[deletedSlug];
        console.log('‚úÖ Also deleted from window.testimonialData');
    }
    
    // Auto-select first industry if none selected
    if (!currentIndustry && Object.keys(currentData.industries || {}).length > 0) {
        const firstIndustrySlug = Object.keys(currentData.industries)[0];
        selectIndustry(firstIndustrySlug);
        console.log('‚úÖ Auto-selected first industry:', firstIndustrySlug);
    }
    
    showMessage(`‚úÖ Deleted industry: ${industryName}`, 'success');
    console.log('‚úÖ Delete completed successfully');
}

// 2. TRIGGER SYSTEM FUNCTIONS
function initTriggerSystem() {
    console.log('Initializing trigger system...');
    
    // Setup trigger type buttons
    document.querySelectorAll('.trigger-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.trigger-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterTriggers(this.dataset.type);
        });
    });
    
    // Setup search input
    const searchInput = document.getElementById('triggerSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const activeType = document.querySelector('.trigger-type-btn.active').dataset.type;
            filterTriggers(activeType, this.value);
        });
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('triggerDropdown');
            if (dropdown && !e.target.closest('#triggerSearch') && !e.target.closest('#triggerDropdown')) {
                dropdown.style.display = 'none';
            }
        });
    }
    
    // Load triggers when industry is selected
    const originalSelectIndustry = selectIndustry;
    selectIndustry = function(slug) {
        originalSelectIndustry(slug);
        setTimeout(() => {
            loadTriggerTemplates();
            filterTriggers('all');
        }, 100);
    };
}

function loadTriggerTemplates() {
    const container = document.getElementById('triggerDropdown');
    if (!container) {
        console.warn('Trigger dropdown container not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (!currentIndustry) {
        container.innerHTML = '<div class="dropdown-item">Select an industry first</div>';
        return;
    }
    
    // Get triggers for this industry + universal
    const triggers = {
        ...triggerTemplates.universal,
        ...(triggerTemplates[currentIndustry] || {})
    };
    
    if (Object.keys(triggers).length === 0) {
        container.innerHTML = '<div class="dropdown-item">No triggers defined for this industry</div>';
        return;
    }
    
    Object.entries(triggers).forEach(([key, trigger]) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.dataset.triggerKey = key;
        item.dataset.triggerType = trigger.type;
        item.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">${trigger.icon}</span>
                <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 14px;">${trigger.title}</div>
                    <div style="font-size: 11px; color: #888;">
                        ${trigger.phrases.slice(0, 3).join(', ')}...
                    </div>
                </div>
                <span style="font-size: 12px; color: #666;">
                    ${getTriggerTypeLabel(trigger.type).split(' ')[0]}
                </span>
            </div>
        `;
        
        item.addEventListener('click', () => {
            selectTrigger(key, trigger);
            document.getElementById('triggerSearch').value = trigger.title;
            container.style.display = 'none';
        });
        
        container.appendChild(item);
    });
}

function filterTriggers(type = 'all', search = '') {
    const container = document.getElementById('triggerDropdown');
    if (!container) return;
    
    const items = container.querySelectorAll('.dropdown-item');
    const searchLower = search.toLowerCase();
    let visibleCount = 0;
    
    items.forEach(item => {
        const matchesType = type === 'all' || item.dataset.triggerType === type;
        const matchesSearch = !searchLower || 
            item.textContent.toLowerCase().includes(searchLower) ||
            item.dataset.triggerKey.toLowerCase().includes(searchLower);
        
        if (matchesType && matchesSearch) {
            item.style.display = 'flex';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    container.style.display = visibleCount > 0 ? 'block' : 'none';
}

function selectTrigger(key, trigger) {
    console.log('Selected trigger:', key, trigger);
    
    // Auto-fill form fields
    document.getElementById('concernName').value = key;
    document.getElementById('concernTitle').value = trigger.title;
    document.getElementById('concernIcon').value = trigger.icon;
    document.getElementById('concernKeywords').value = trigger.phrases.join(', ');
    
    // Show preview
    const preview = document.getElementById('triggerPreview');
    if (preview) {
        document.getElementById('previewIcon').textContent = trigger.icon;
        document.getElementById('previewTitle').textContent = trigger.title;
        document.getElementById('previewType').textContent = `Type: ${getTriggerTypeLabel(trigger.type)}`;
        
        const phrasesHTML = trigger.phrases
            .map(phrase => `<span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 12px;">${phrase}</span>`)
            .join('');
        
        document.getElementById('previewPhrases').innerHTML = phrasesHTML;
        preview.style.display = 'block';
    }
    
    // Show success message
    if (typeof showMessage === 'function') {
        showMessage(`‚úÖ Loaded trigger: ${trigger.title}`, 'success');
    }
}

function getTriggerTypeLabel(type) {
    const labels = {
        'negative': '‚ùå Negative Objection',
        'positive': '‚úÖ Positive Inquiry', 
        'comparison': 'ü§î Comparison Question',
        'how-to': 'üîç How-To/Process'
    };
    return labels[type] || type;
}

// üé¨ TESTIMONIAL VIEWER FUNCTIONS

// 1. Update testimonial cards in sidebar
function updateTestimonialCards() {
    const container = document.getElementById('testimonialCardsContainer');
    if (!container) return;
    
    // Get all testimonials
    const allTestimonials = getAllTestimonials();
    
    if (allTestimonials.length === 0) {
        container.innerHTML = `
            <div class="testimonial-card-empty" style="text-align: center; padding: 20px; background: rgba(33,37,41,0.3); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.1); color: #6c757d;">
                <div style="font-size: 24px; margin-bottom: 8px;">üé¨</div>
                <div>No testimonials yet</div>
                <div style="font-size: 12px; margin-top: 5px;">Add your first testimonial</div>
            </div>
        `;
        return;
    }
    
    // Show latest 3 testimonials
    const latestTestimonials = allTestimonials.slice(0, 3);
    container.innerHTML = '';
    
    latestTestimonials.forEach(testimonial => {
        const card = document.createElement('div');
        card.className = 'testimonial-card';
        card.style.cssText = `
            background: rgba(33,37,41,0.5);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        card.onmouseover = () => {
            card.style.background = 'rgba(33,37,41,0.8)';
            card.style.transform = 'translateY(-2px)';
        };
        card.onmouseout = () => {
            card.style.background = 'rgba(33,37,41,0.5)';
            card.style.transform = 'translateY(0)';
        };
        card.onclick = () => playTestimonialVideo(testimonial);
        
        card.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="font-size: 20px; color: #80bdff;">${testimonial.icon || 'üé¨'}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #e9ecef; font-size: 14px; margin-bottom: 4px;">
                        ${testimonial.title || testimonial.concern || 'Testimonial'}
                    </div>
                    <div style="color: #adb5bd; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        "${testimonial.text}"
                    </div>
                    <div style="color: #6c757d; font-size: 11px; margin-top: 6px;">
                        ${testimonial.author || 'Anonymous'}
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// 2. Get all testimonials from all industries
function getAllTestimonials() {
    const allTestimonials = [];
    
    // Get from currentData if available
    if (window.currentData && window.currentData.industries) {
        Object.values(window.currentData.industries).forEach(industry => {
            if (industry.concerns) {
                Object.values(industry.concerns).forEach(concern => {
                    if (concern.reviews) {
                        concern.reviews.forEach(review => {
                            allTestimonials.push({
                                ...review,
                                concern: concern.title,
                                icon: concern.icon,
                                concernType: concern.videoType,
                                industry: industry.name,
                                industrySlug: Object.keys(window.currentData.industries).find(
                                    slug => window.currentData.industries[slug] === industry
                                )
                            });
                        });
                    }
                });
            }
        });
    }
    
    // Get from universal concerns
    if (window.testimonialData && window.testimonialData.concerns) {
        Object.entries(window.testimonialData.concerns).forEach(([key, concern]) => {
            if (concern.reviews) {
                concern.reviews.forEach(review => {
                    allTestimonials.push({
                        ...review,
                        concern: concern.title,
                        icon: concern.icon,
                        concernType: concern.videoType,
                        industry: 'General Business',
                        industrySlug: 'general'
                    });
                });
            }
        });
    }
    
    return allTestimonials;
}

// 3. Show all testimonials modal
function showAllTestimonialsModal() {
    const modal = document.getElementById('allTestimonialsModal');
    if (!modal) return;
    
    // Update count
    const allTestimonials = getAllTestimonials();
    document.getElementById('totalTestimonialsCount').textContent = allTestimonials.length;
    
    // Populate industry filter
    const industryFilter = document.getElementById('testimonialFilterIndustry');
    industryFilter.innerHTML = '<option value="">All Industries</option>';
    
    if (window.currentData && window.currentData.industries) {
        Object.entries(window.currentData.industries).forEach(([slug, industry]) => {
            const option = document.createElement('option');
            option.value = slug;
            option.textContent = industry.name;
            industryFilter.appendChild(option);
        });
    }
    
    // Show testimonials
    renderAllTestimonials(allTestimonials);
    
    // Show modal
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// 4. Hide all testimonials modal
function hideAllTestimonialsModal() {
    const modal = document.getElementById('allTestimonialsModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// 5. Render testimonials in grid
function renderAllTestimonials(testimonials) {
    const grid = document.getElementById('allTestimonialsGrid');
    if (!grid) return;
    
    if (testimonials.length === 0) {
        grid.innerHTML = `
            <div class="testimonial-empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                <div style="font-size: 48px; margin-bottom: 20px;">üé¨</div>
                <h3 style="color: #adb5bd;">No testimonials found</h3>
                <p>Add testimonials to see them here</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = '';
    
    testimonials.forEach(testimonial => {
        const card = document.createElement('div');
        card.className = 'testimonial-grid-card';
        card.style.cssText = `
            background: rgba(33,37,41,0.5);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        card.onmouseover = () => {
            card.style.background = 'rgba(33,37,41,0.8)';
            card.style.transform = 'translateY(-2px)';
            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
        };
        card.onmouseout = () => {
            card.style.background = 'rgba(33,37,41,0.5)';
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'none';
        };
        card.onclick = () => playTestimonialVideo(testimonial);
        
        card.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="font-size: 24px; color: #80bdff;">${testimonial.icon || 'üé¨'}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #e9ecef; font-size: 14px; margin-bottom: 6px;">
                        ${testimonial.concern || 'Testimonial'}
                    </div>
                    <div style="color: #adb5bd; font-size: 13px; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                        "${testimonial.text}"
                    </div>
                    <div style="color: #6c757d; font-size: 12px; margin-bottom: 4px;">
                        üë§ ${testimonial.author || 'Anonymous'}
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #6c757d;">
                        <span>üè¢ ${testimonial.industry || 'General'}</span>
                        <button onclick="event.stopPropagation(); playTestimonialVideo(${JSON.stringify(testimonial)})" 
                                style="background: rgba(0,123,255,0.2); color: #80bdff; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            ‚ñ∂Ô∏è Play
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

// 6. Filter testimonials
function filterTestimonials() {
    const industry = document.getElementById('testimonialFilterIndustry').value;
    const type = document.getElementById('testimonialFilterType').value;
    
    let filtered = getAllTestimonials();
    
    if (industry) {
        filtered = filtered.filter(t => t.industrySlug === industry);
    }
    
    if (type) {
        filtered = filtered.filter(t => {
            if (type === 'price') return t.icon === 'üí∞' || t.concernType === 'skeptical';
            if (type === 'time') return t.icon === '‚è∞' || t.concernType === 'speed';
            if (type === 'trust') return t.icon === 'ü§ù' || t.concernType === 'skeptical';
            if (type === 'results') return t.icon === 'üìà' || t.concernType === 'results';
            return true;
        });
    }
    
    renderAllTestimonials(filtered);
}

// 7. Reset filters
function resetTestimonialFilters() {
    document.getElementById('testimonialFilterIndustry').value = '';
    document.getElementById('testimonialFilterType').value = '';
    renderAllTestimonials(getAllTestimonials());
}

// 8. Play testimonial video
function playTestimonialVideo(testimonial) {
    const modal = document.getElementById('videoPlayerModal');
    const videoPlayer = document.getElementById('testimonialVideoPlayer');
    const videoTitle = document.getElementById('videoPlayerTitle');
    const videoAuthor = document.getElementById('videoAuthor');
    const videoConcern = document.getElementById('videoConcern');
    const videoIndustry = document.getElementById('videoIndustry');
    
    if (!modal || !videoPlayer) return;
    
    // Set video info
    videoTitle.textContent = testimonial.concern || 'Testimonial';
    videoAuthor.textContent = testimonial.author || 'Unknown';
    videoConcern.textContent = testimonial.concern || 'General';
    videoIndustry.textContent = testimonial.industry || 'General Business';
    
    // Set video source (you'll need to adjust this based on your video storage)
    if (testimonial.videoUrl) {
        videoPlayer.src = testimonial.videoUrl;
    } else if (window.currentData && window.currentData.videos && testimonial.videoType) {
        videoPlayer.src = window.currentData.videos[testimonial.videoType] || '';
    }
    
    // Show modal
    modal.style.display = 'flex';
    
    // Play video
    videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
}

// 9. Hide video player
function hideVideoPlayer() {
    const modal = document.getElementById('videoPlayerModal');
    const videoPlayer = document.getElementById('testimonialVideoPlayer');
    
    if (modal) modal.style.display = 'none';
    if (videoPlayer) {
        videoPlayer.pause();
        videoPlayer.currentTime = 0;
    }
}

// 10. Initialize
function initTestimonialViewer() {
    // Update cards on load
    updateTestimonialCards();
    
    // Close modals on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideAllTestimonialsModal();
            hideVideoPlayer();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('allTestimonialsModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'allTestimonialsModal') {
            hideAllTestimonialsModal();
        }
    });
    
    document.getElementById('videoPlayerModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'videoPlayerModal') {
            hideVideoPlayer();
        }
    });
    
    console.log('‚úÖ Testimonial viewer initialized');
}

// Run initialization
setTimeout(initTestimonialViewer, 500);

// 3. UPDATE ADD TESTIMONIAL FUNCTION TO SAVE TRIGGERS
function addVideoTestimonial() {
    // ... your existing code ...
    
    // ADD THIS LINE to capture keywords/phrases
    const triggerPhrases = document.getElementById('concernKeywords').value
        .split(',')
        .map(k => k.trim())
        .filter(k => k);
    
    // In your concern creation, add the phrases
    currentData.industries[targetIndustry].concerns[concernKey] = {
        title: concernTitle,
        icon: concernIcon,
        videoType: videoKey,
        phrases: triggerPhrases, // ‚Üê ADD THIS LINE
        reviews: []
    };
    
    // ... rest of your code ...
}

// 4. INITIALIZE TRIGGER SYSTEM ON PAGE LOAD
document.addEventListener('DOMContentLoaded', function() {
    // ... your existing initialization ...
    
    // ADD THIS LINE:
    setTimeout(initTriggerSystem, 500);
});
// üìã FIXED CONNECTION SCRIPT - WITH LOAD WAITINGfunction connectTestimonialAI() {
    console.log('üîó Connecting testimonial AI to management system...');
    
    // Wait for testimonialData to be fully loaded
    const checkDataLoaded = () => {
        if (!window.testimonialData) {
            console.log('‚è≥ Waiting for testimonialData to load...');
            setTimeout(checkDataLoaded, 100);
            return;
        }
        
        if (!window.testimonialData.findRelevantTestimonial) {
            console.log('‚ö†Ô∏è findRelevantTestimonial not found, adding it...');
            
            // Add the function if missing
            window.testimonialData.findRelevantTestimonial = function(userMessage) {
                console.log('üîç Searching testimonials for:', userMessage.substring(0, 50));
                
                const message = userMessage.toLowerCase();
                
                if (this.universalConcerns) {
                    for (const [key, concern] of Object.entries(this.universalConcerns)) {
                        if (concern.phrases && Array.isArray(concern.phrases)) {
                            for (const phrase of concern.phrases) {
                                if (phrase && message.includes(phrase.toLowerCase())) {
                                    console.log(`‚úÖ Matched "${phrase}" in ${concern.title}`);
                                    
                                    if (concern.reviews && concern.reviews.length > 0) {
                                        const randomReview = concern.reviews[Math.floor(Math.random() * concern.reviews.length)];
                                        return {
                                            type: 'universal',
                                            concern: concern.title,
                                            review: randomReview.text,
                                            author: randomReview.author,
                                            icon: concern.icon,
                                            videoType: concern.videoType
                                        };
                                    }
                                }
                            }
                        }
                    }
                }
                
                console.log('‚ùå No testimonial match found');
                return null;
            };
        }
        
        console.log('‚úÖ Testimonial AI functions are available');
        
        // Continue with the rest of the connection...
        setupConnection();

         // Start checking
    checkDataLoaded();
    };
    

function setupConnection() {
    console.log('üîß Setting up testimonial connections...');
    
    // 1. Check URL parameters for concerns
    const urlParams = new URLSearchParams(window.location.search);
    const concernFromUrl = urlParams.get('concern');
    if (concernFromUrl) {
        console.log('üîç Concern from URL:', concernFromUrl);
        showRelevantTestimonial(concernFromUrl);
    }
    
    // 2. Listen for form submissions
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const textarea = this.querySelector('textarea');
            if (textarea && textarea.value) {
                console.log('üìù Form submission detected:', textarea.value.substring(0, 50));
                const result = window.testimonialData.findRelevantTestimonial(textarea.value);
                if (result) {
                    e.preventDefault();
                    showRelevantTestimonial(result);
                }
            }
        });
    });
    
    // 3. Intercept button clicks
    document.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (button) {
            const buttonText = button.textContent.toLowerCase().trim();
            
            const concernKeywords = [
                'price', 'expensive', 'cost', 'afford', 'budget',
                'time', 'long', 'fast', 'quick', 'speed', 
                'trust', 'scam', 'reliable', 'skeptical',
                'results', 'work', 'effective', 'outcome'
            ];
            
            for (const keyword of concernKeywords) {
                if (buttonText.includes(keyword)) {
                    console.log(`üéØ Concern button: "${button.textContent.trim()}"`);
                    
                    const result = window.testimonialData.findRelevantTestimonial(buttonText);
                    if (result) {
                        console.log('‚úÖ Found testimonial:', result);
                        
                        if (window.showTestimonialForConcern) {
                            window.showTestimonialForConcern(result.concernType || result.type);
                        } else if (window.displayRelevantTestimonial) {
                            window.displayRelevantTestimonial(result);
                        } else {
                            showTestimonialPopup(result);
                        }
                    }
                    break;
                }
            }
        }
    });
    
    // 4. Add debug panel
    addDebugPanel();
    
    console.log('‚úÖ Testimonial AI fully connected!');
}

// Function to display the testimonial result (enhanced version)
function showRelevantTestimonial(dataOrText) {
    console.log('üì∫ Showing testimonial:', dataOrText);
    
    // If it's text, find matching testimonial
    let result;
    if (typeof dataOrText === 'string') {
        result = window.testimonialData.findRelevantTestimonial(dataOrText);
    } else {
        result = dataOrText;
    }
    
    if (!result) {
        console.log('‚ùå No testimonial found for:', dataOrText);
        return;
    }
    
    // Call the enhanced display function
    showTestimonialPopup(result);
}

// SIMPLIFIED & WORKING VERSION
function showTestimonialPopup(testimonial) {
    console.log('üì∫ Showing testimonial:', testimonial.concern);
    
    // Remove any existing
    document.querySelectorAll('.testimonial-container').forEach(el => el.remove());
    
    // Create container
    const container = document.createElement('div');
    container.className = 'testimonial-container';
    container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
    `;
    overlay.onclick = () => container.remove();
    
    // Create popup
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: relative;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        max-width: 500px;
        width: 90%;
        text-align: center;
        border-top: 5px solid #007bff;
        z-index: 10001;
    `;
    
    popup.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">${testimonial.icon}</div>
        <h3 style="margin: 0 0 10px; color: #333;">${testimonial.concern}</h3>
        <p style="font-size: 18px; font-style: italic; color: #555; margin: 20px 0;">"${testimonial.review}"</p>
        <p style="color: #777; font-weight: bold; margin-bottom: 25px;">- ${testimonial.author}</p>
        <button onclick="this.closest('.testimonial-container').remove()" style="
            padding: 10px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        ">Continue</button>
    `;
    
    // Assemble
    container.appendChild(overlay);
    container.appendChild(popup);
    document.body.appendChild(container);
    
    // Auto-close
    setTimeout(() => container.remove(), 8000);
}
    
    // SAFE Close function (REPLACE YOUR CURRENT ONE)
window.closeTestimonialPopup = function() {
    // Find overlay by ID AND by class
    const overlay = document.getElementById('testimonial-overlay');
    if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
    }
    
    // Find popup by looking for its unique style
    const popups = document.querySelectorAll('div');
    popups.forEach(div => {
        const style = div.getAttribute('style') || '';
        if (style.includes('top: 50%') && 
            style.includes('left: 50%') && 
            style.includes('transform: translate(-50%, -50%)')) {
            if (div.parentNode) {
                div.parentNode.removeChild(div);
            }
        }
    });
};
    

// Debug panel function (from my script)
function addDebugPanel() {
    const panel = document.createElement('div');
    panel.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 9998;
        font-family: Arial, sans-serif;
        max-width: 300px;
        animation: slideInLeft 0.5s ease-out;
    `;
    
    panel.innerHTML = `
        <h4 style="margin-top: 0; color: #007bff;">üéØ Testimonial AI Debug</h4>
        <p style="margin: 10px 0; font-size: 12px; color: #666;">Click buttons below to test:</p>
        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
            <button onclick="testConcern('price')" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">üí∞ Price</button>
            <button onclick="testConcern('time')" style="padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">‚è∞ Time</button>
            <button onclick="testConcern('trust')" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">ü§ù Trust</button>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <button onclick="testConcern('general')" style="padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">‚≠ê General</button>
            <button onclick="testConcern('results')" style="padding: 5px 10px; background: #ffc107; color: #333; border: none; border-radius: 3px; cursor: pointer;">üìà Results</button>
        </div>
        <p style="margin: 10px 0 0; font-size: 10px; color: #999;">AI Matching: ACTIVE</p>
    `;
    
    // Add animation CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(panel);
    
    // Add test function to window
    window.testConcern = function(type) {
        const messages = {
            price: 'This is too expensive for my budget',
            time: 'The process takes too long to implement',
            trust: 'I\'m not sure if I can trust this company',
            general: 'I\'m on the fence about this decision',
            results: 'Does this actually work and get results?'
        };
        
        const message = messages[type] || 'Test concern';
        console.log(`üß™ Testing ${type}: "${message}"`);
        
        const result = window.testimonialData.findRelevantTestimonial(message);
        if (result) {
            showTestimonialPopup(result);
        } else {
            alert(`‚ùå No testimonial found for "${type}" concern`);
        }
    };
}
        
        // ===================================================
        // INITIALIZATION
        // ===================================================
       function initialize() {
    console.log('üöÄ Initializing Testimonial Manager PRO...');
    
    // Load from localStorage
    const saved = localStorage.getItem('testimonialData');
    
    if (saved) {
        try {
            currentData = JSON.parse(saved);
            console.log('üìÇ Loaded saved data from localStorage');
            validateDataStructure();
        } catch (e) {
            console.error('Error loading data:', e);
            initializeWithDefaults();
        }
    } else {
        initializeWithDefaults();
    }
    
    // ============ CRITICAL: SYNC WITH TESTIMONIAL-DATA.JS ============
    console.log('üîÑ Syncing with testimonials-data.js...');
    syncWithExternalData();
    // =================================================================
    
    updateIndustryList();
    updateStats();
    updateCodePreview();
    
    // Auto-select first industry
    syncIndustrySelection();
    
    showMessage('‚úÖ System ready!', 'success');
}

// NEW FUNCTION: Sync with external data
function syncWithExternalData() {
    if (!window.testimonialData || !window.testimonialData.industries) {
        console.warn('No external testimonial data found');
        return;
    }
    
    // Ensure currentData structure exists
    if (!currentData.industries) currentData.industries = {};
    if (!currentData.industryKeywords) currentData.industryKeywords = {};
    
    const external = window.testimonialData;
    let addedCount = 0;
    let updatedCount = 0;
    
    // Sync industries
    Object.entries(external.industries).forEach(([slug, extIndustry]) => {
        if (!currentData.industries[slug]) {
            // Add missing industry
            currentData.industries[slug] = {
                name: extIndustry.name,
                icon: extIndustry.icon || 'üè¢',
                concerns: extIndustry.concerns ? {...extIndustry.concerns} : {}
            };
            addedCount++;
            console.log(`‚ûï Added industry: ${extIndustry.name}`);
        } else {
            // Update existing industry (preserve user modifications but sync basics)
            currentData.industries[slug].name = extIndustry.name;
            currentData.industries[slug].icon = extIndustry.icon || currentData.industries[slug].icon;
            updatedCount++;
        }
    });
    
    // Sync keywords
    if (external.industryKeywords) {
        currentData.industryKeywords = {...currentData.industryKeywords, ...external.industryKeywords};
    }
    
    // Sync universal concerns
    if (external.concerns) {
        currentData.universalConcerns = {...currentData.universalConcerns, ...external.concerns};
    }
    
    // Sync player config
    if (external.playerConfig) {
        currentData.playerConfig = {...currentData.playerConfig, ...external.playerConfig};
    }
    
    console.log(`‚úÖ Sync complete: +${addedCount} added, ${updatedCount} updated`);
    
    // Save synced data
    saveAllData();
}

// NEW FUNCTION: Auto-select industry intelligently
function syncIndustrySelection() {
    const industrySlugs = Object.keys(currentData.industries);
    
    if (industrySlugs.length === 0) {
        console.warn('No industries available');
        currentIndustry = null;
        return;
    }
    
    // If no industry selected OR selected industry doesn't exist anymore
    if (!currentIndustry || !currentData.industries[currentIndustry]) {
        // Select first available industry
        const firstSlug = industrySlugs[0];
        selectIndustry(firstSlug);
        console.log(`‚úÖ Auto-selected first industry: ${firstSlug}`);
    } else {
        // Refresh current industry
        selectIndustry(currentIndustry);
    }
}

function validateDataStructure() {
    // Ensure all required objects exist
    if (!currentData.industries) currentData.industries = {};
    if (!currentData.videos) currentData.videos = {};
    if (!currentData.industryKeywords) currentData.industryKeywords = {};
    if (!currentData.universalConcerns) {
        currentData.universalConcerns = {
            price: { title: 'See The ROI Others Achieved', icon: 'üí∞', videoType: 'universal-price', reviews: [] },
            time: { title: 'For Busy Professionals', icon: '‚è∞', videoType: 'universal-time', reviews: [] },
            trust: { title: 'Proven Across Industries', icon: 'ü§ù', videoType: 'universal-trust', reviews: [] }
        };
    }
    if (!currentData.playerConfig) {
        currentData.playerConfig = {
            desktop: { width: 854, height: 480, top: '50%', left: '50%', borderRadius: '12px' },
            mobile: { fullscreen: true },
            overlay: { background: 'rgba(0, 0, 0, 0.5)' },
            resumeMessage: "I'm sure you can appreciate what similar businesses have achieved..."
        };
    }
}

// ===================================================
// INDUSTRY-SPECIFIC FUNCTIONALITY
// ===================================================

function populateIndustryDropdown() {
    const industries = window.testimonialData.getAllIndustries();
    const dropdown = document.getElementById('industry-select');
    
    if (!dropdown) {
        console.error('Industry dropdown not found');
        return;
    }
    
    // Clear existing options
    dropdown.innerHTML = '<option value="">Select an industry...</option>';
    
    // Add industry options
    industries.forEach(industry => {
        const option = document.createElement('option');
        option.value = industry.slug;
        option.textContent = `${industry.icon} ${industry.name}`;
        dropdown.appendChild(option);
    });
    
    // Add change listener
    dropdown.addEventListener('change', function() {
        const industrySlug = this.value;
        if (industrySlug) {
            selectIndustry(industrySlug);
            populateConcernsForIndustry(industrySlug);
        }
    });
}

function populateConcernsForIndustry(industrySlug) {
    const industryData = window.testimonialData.getIndustryTestimonials(industrySlug);
    const concernsContainer = document.getElementById('concerns-container');
    
    if (!concernsContainer) return;
    
    // Clear existing concerns
    concernsContainer.innerHTML = '';
    
    // Add concerns for this industry
    Object.entries(industryData.concerns).forEach(([key, concern]) => {
        const concernId = `concern-${key}`;
        const concernHTML = `
            <div class="concern-option">
                <input type="checkbox" 
                       id="${concernId}" 
                       name="concerns" 
                       value="${key}"
                       data-phrases="${JSON.stringify(concern.phrases || []).replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                       class="concern-checkbox">
                <label for="${concernId}">
                    <span class="concern-icon">${concern.icon}</span>
                    <span class="concern-title">${concern.title}</span>
                </label>
                <div class="trigger-phrases-preview" id="phrases-${key}">
                    ${(concern.phrases || []).slice(0, 3).map(phrase => 
                        `<span class="phrase-tag">${phrase}</span>`
                    ).join('')}
                    ${(concern.phrases || []).length > 3 ? 
                        `<span class="phrase-more">+${(concern.phrases || []).length - 3} more</span>` : 
                        ''
                    }
                </div>
            </div>
        `;
        concernsContainer.innerHTML += concernHTML;
    });
    
   // FIXED: Add click handlers to concerns
document.querySelectorAll('.concern-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            try {
                // PARSE the JSON string first!
                function safeParsePhrases(jsonString) {
    if (!jsonString) return [];
    
    try {
        // First try normal parse
        return JSON.parse(jsonString);
    } catch (error) {
        console.log('JSON parse failed, trying to fix...');
        
        // If string is truncated, try to reconstruct
        if (jsonString.includes('[') && !jsonString.includes(']')) {
            // Try to complete the JSON
            let fixed = jsonString;
            
            // Add missing closing bracket
            if (!fixed.endsWith(']')) {
                // Check if we need to close a string
                const quoteCount = (fixed.match(/"/g) || []).length;
                if (quoteCount % 2 === 1) {
                    fixed += '"';
                }
                fixed += ']';
            }
            
            try {
                return JSON.parse(fixed);
            } catch (e) {
                // Extract strings manually
                const matches = fixed.match(/"([^"]+)"/g) || [];
                return matches.map(m => m.slice(1, -1));
            }
        }
        
        return [];
    }
}

// Then use it:
const phrases = safeParsePhrases(this.dataset.phrases);
                
                // Call with PARSED array, not string
                populateTriggerPhrases(phrases);
                
                // Also update concernKeywords textarea
                const concernKeywords = document.getElementById('concernKeywords');
                if (concernKeywords && phrases.length > 0) {
                    const current = concernKeywords.value.trim();
                    const newPhrases = phrases.join(', ');
                    
                    if (current) {
                        if (!current.includes(newPhrases)) {
                            concernKeywords.value = `${current}, ${newPhrases}`;
                        }
                    } else {
                        concernKeywords.value = newPhrases;
                    }
                    
                    // Visual feedback
                    concernKeywords.style.border = '2px solid #4CAF50';
                    setTimeout(() => {
                        concernKeywords.style.border = '';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error parsing checkbox phrases:', error);
                console.log('Raw data:', this.dataset.phrases);
            }
        } else {
            // When unchecked, remove from concernKeywords
            const concernKeywords = document.getElementById('concernKeywords');
            if (concernKeywords) {
                try {
                    function safeParsePhrases(jsonString) {
    if (!jsonString) return [];
    
    try {
        // First try normal parse
        return JSON.parse(jsonString);
    } catch (error) {
        console.log('JSON parse failed, trying to fix...');
        
        // If string is truncated, try to reconstruct
        if (jsonString.includes('[') && !jsonString.includes(']')) {
            // Try to complete the JSON
            let fixed = jsonString;
            
            // Add missing closing bracket
            if (!fixed.endsWith(']')) {
                // Check if we need to close a string
                const quoteCount = (fixed.match(/"/g) || []).length;
                if (quoteCount % 2 === 1) {
                    fixed += '"';
                }
                fixed += ']';
            }
            
            try {
                return JSON.parse(fixed);
            } catch (e) {
                // Extract strings manually
                const matches = fixed.match(/"([^"]+)"/g) || [];
                return matches.map(m => m.slice(1, -1));
            }
        }
        
        return [];
    }
}

// Then use it:
const phrases = safeParsePhrases(this.dataset.phrases);
                    const phrasesToRemove = phrases.join(', ');
                    let newValue = concernKeywords.value;
                    
                    // Simple removal logic
                    phrases.forEach(phrase => {
                        newValue = newValue.replace(phrase, '')
                            .replace(/\s*,\s*,/g, ',')
                            .replace(/^,|,$/g, '')
                            .trim();
                    });
                    
                    concernKeywords.value = newValue;
                } catch (e) {
                    // Ignore parse errors on uncheck
                }
            }
        }
        
        // Always update preview
        if (typeof updateCodePreview === 'function') {
            updateCodePreview();
        }
    });
});
}

// ==============================================
// NEW: POPULATE TRIGGER PHRASES DROPDOWN
// ==============================================
function populateTriggerPhrases(phrases) {
    const triggerDropdown = document.getElementById('trigger-dropdown');
    const triggerSearch = document.getElementById('trigger-search');
    
    if (!triggerDropdown || !triggerSearch) return;
    
    // Clear existing options
    triggerDropdown.innerHTML = '';
    
    // Debug: Check what we're receiving
    console.log('populateTriggerPhrases received:', phrases);
    console.log('Type:', typeof phrases);
    
    // Ensure phrases is an array
    if (!phrases) {
        console.warn('No phrases provided');
        return;
    }
    
    // If phrases is a string, try to parse it as JSON
    if (typeof phrases === 'string') {
        try {
            phrases = JSON.parse(phrases);
        } catch (e) {
            console.warn('Could not parse phrases string:', e);
            console.warn('String content:', phrases);
            return;
        }
    }
    
    // Check if it's actually an array
    if (!Array.isArray(phrases)) {
        console.warn('phrases is not an array:', phrases);
        return;
    }
    
    // Add phrase options
    phrases.forEach(phrase => {
        const option = document.createElement('div');
        option.className = 'trigger-option';
        option.textContent = phrase;
        option.addEventListener('click', function() {
            triggerSearch.value = phrase;
            triggerDropdown.style.display = 'none';
            updateCodePreview();
        });
        triggerDropdown.appendChild(option);
    });
    
    // Show dropdown if there are phrases
    if (phrases.length > 0 && triggerSearch === document.activeElement) {
        triggerDropdown.style.display = 'block';
    }
}

// ===================================================
// UPDATE YOUR EXISTING FUNCTIONS
// ===================================================

function updateCodePreview() {
    // Get selected industry
    const industrySelect = document.getElementById('industry-select');
    const industrySlug = industrySelect ? industrySelect.value : '';
    
    // Get selected concerns
    const selectedConcerns = Array.from(
        document.querySelectorAll('.concern-checkbox:checked')
    ).map(cb => ({
        key: cb.value,
        title: cb.nextElementSibling.querySelector('.concern-title').textContent,
        phrases: JSON.parse(cb.dataset.phrases || '[]')
    }));
    
    // Get trigger phrase
    const triggerPhrase = document.getElementById('trigger-search')?.value || '';
    
    // Build the code output
    let code = `// Testimonial Configuration for ${industrySlug || 'General'}\n`;
    code += `const testimonialConfig = {\n`;
    code += `  industry: "${industrySlug}",\n`;
    
    if (selectedConcerns.length > 0) {
        code += `  concerns: [\n`;
        selectedConcerns.forEach((concern, index) => {
            code += `    {\n`;
            code += `      key: "${concern.key}",\n`;
            code += `      title: "${concern.title}",\n`;
            code += `      phrases: ${JSON.stringify(concern.phrases, null, 6)}\n`;
            code += `    }${index < selectedConcerns.length - 1 ? ',' : ''}\n`;
        });
        code += `  ],\n`;
    }
    
    if (triggerPhrase) {
        code += `  triggerPhrase: "${triggerPhrase}",\n`;
    }
    
    code += `  // Add video testimonials here\n`;
    code += `  videos: []\n`;
    code += `};\n`;
    
    // Update the preview
    const preview = document.getElementById('code-preview');
    if (preview) {
        preview.textContent = code;
        
        // Syntax highlighting (basic)
        preview.innerHTML = code
            .replace(/\/\/.*$/gm, '<span class="comment">$&</span>')
            .replace(/".*?"/g, '<span class="string">$&</span>')
            .replace(/\b(const|let|var|function|return|if|else)\b/g, '<span class="keyword">$&</span>');
    }
}

// ===================================================
// INITIALIZE ON PAGE LOAD
// ===================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize industry dropdown
    populateIndustryDropdown();
    
    // If you have a default industry, select it
    const defaultIndustry = 'general';
    const industrySelect = document.getElementById('industry-select');
    if (industrySelect) {
        industrySelect.value = defaultIndustry;
        populateConcernsForIndustry(defaultIndustry);
    }
    
    // Initialize code preview
    updateCodePreview();
});

// ==============================================
// NEW: UPDATE CONCERNS BASED ON INDUSTRY
// ==============================================
function updateConcernsForIndustry(industrySlug) {
    const testimonials = window.testimonialData.getIndustryTestimonials(industrySlug);
    const concernsContainer = document.getElementById('concerns-container');
    
    if (!concernsContainer) return;
    
    // Clear existing concern checkboxes
    concernsContainer.innerHTML = '';
    
    // Add checkboxes for each concern
    Object.entries(testimonials.concerns).forEach(([key, concern]) => {
        const concernId = `concern-${key}`;
        
        const concernHTML = `
        <div class="concern-option">
            <input type="checkbox" 
                   id="${concernId}" 
                   name="concerns" 
                   value="${key}" 
                   data-title="${concern.title}"
                   data-icon="${concern.icon}"
                   data-video-type="${concern.videoType}"
                   data-phrases="${JSON.stringify(concern.phrases || []).replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                   class="concern-checkbox">
            <label for="${concernId}">
                <span class="concern-icon">${concern.icon}</span>
                <span class="concern-title">${concern.title}</span>


            </label>
        </div>
        `;
        
        concernsContainer.innerHTML += concernHTML;
    });
    
    // ============ FIXED: Updated click handlers ============
    document.querySelectorAll('.concern-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // When checked, add phrases to concernKeywords textarea
                function safeParsePhrases(jsonString) {
    if (!jsonString) return [];
    
    try {
        // First try normal parse
        return JSON.parse(jsonString);
    } catch (error) {
        console.log('JSON parse failed, trying to fix...');
        
        // If string is truncated, try to reconstruct
        if (jsonString.includes('[') && !jsonString.includes(']')) {
            // Try to complete the JSON
            let fixed = jsonString;
            
            // Add missing closing bracket
            if (!fixed.endsWith(']')) {
                // Check if we need to close a string
                const quoteCount = (fixed.match(/"/g) || []).length;
                if (quoteCount % 2 === 1) {
                    fixed += '"';
                }
                fixed += ']';
            }
            
            try {
                return JSON.parse(fixed);
            } catch (e) {
                // Extract strings manually
                const matches = fixed.match(/"([^"]+)"/g) || [];
                return matches.map(m => m.slice(1, -1));
            }
        }
        
        return [];
    }
}

// Then use it:
const phrases = safeParsePhrases(this.dataset.phrases);
                const concernKeywords = document.getElementById('concernKeywords');
                
                if (concernKeywords && phrases.length > 0) {
                    // Get current value
                    const currentValue = concernKeywords.value.trim();
                    const newPhrases = phrases.join(', ');
                    
                    if (currentValue) {
                        // Add to existing if not already there
                        if (!currentValue.includes(newPhrases)) {
                            concernKeywords.value = `${currentValue}, ${newPhrases}`;
                        }
                    } else {
                        // First time - set it
                        concernKeywords.value = newPhrases;
                    }
                    
                    console.log('‚úÖ Added to concernKeywords:', newPhrases);
                    
                    // Visual feedback
                    concernKeywords.style.border = '2px solid #4CAF50';
                    concernKeywords.style.background = '#e8f5e8';
                    setTimeout(() => {
                        concernKeywords.style.border = '';
                        concernKeywords.style.background = '';
                    }, 1000);
                }
                
                // ============ REMOVED: populateTriggerPhrases call ============
                // This was trying to populate trigger-search which doesn't exist here
                // ==============================================================
            } else {
                // If unchecked, remove phrases from concernKeywords
                const concernKeywords = document.getElementById('concernKeywords');
                if (concernKeywords) {
                    function safeParsePhrases(jsonString) {
    if (!jsonString) return [];
    
    try {
        // First try normal parse
        return JSON.parse(jsonString);
    } catch (error) {
        console.log('JSON parse failed, trying to fix...');
        
        // If string is truncated, try to reconstruct
        if (jsonString.includes('[') && !jsonString.includes(']')) {
            // Try to complete the JSON
            let fixed = jsonString;
            
            // Add missing closing bracket
            if (!fixed.endsWith(']')) {
                // Check if we need to close a string
                const quoteCount = (fixed.match(/"/g) || []).length;
                if (quoteCount % 2 === 1) {
                    fixed += '"';
                }
                fixed += ']';
            }
            
            try {
                return JSON.parse(fixed);
            } catch (e) {
                // Extract strings manually
                const matches = fixed.match(/"([^"]+)"/g) || [];
                return matches.map(m => m.slice(1, -1));
            }
        }
        
        return [];
    }
}

// Then use it:
const phrases = safeParsePhrases(this.dataset.phrases);
                    const phrasesToRemove = phrases.join(', ');
                    
                    // Remove the specific phrases
                    let newValue = concernKeywords.value
                        .replace(new RegExp(phrasesToRemove.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '')
                        .replace(/,\s*,/g, ',')      // Clean up double commas
                        .replace(/^\s*,\s*|\s*,\s*$/g, '')  // Clean up leading/trailing commas
                        .replace(/\s+/g, ' ')         // Normalize spaces
                        .trim();
                    
                    concernKeywords.value = newValue;
                    console.log('‚ùå Removed from concernKeywords:', phrasesToRemove);
                }
            }
            
            // Update code preview if function exists
            if (typeof updateCodePreview === 'function') {
                updateCodePreview();
            }
        });
    });
}

// ==============================================
// NEW: POPULATE TRIGGER PHRASES DROPDOWN
// ==============================================
function populateTriggerPhrases(phrases) {
    const triggerDropdown = document.getElementById('trigger-dropdown');
    const triggerSearch = document.getElementById('trigger-search');
    
    if (!triggerDropdown || !triggerSearch) return;
    
    // Clear existing options
    triggerDropdown.innerHTML = '';
    
    // Ensure phrases is an array
    if (!phrases) {
        console.warn('No phrases provided to populateTriggerPhrases');
        return;
    }
    
    // Convert to array if it's a string
    if (typeof phrases === 'string') {
        try {
            phrases = JSON.parse(phrases);
        } catch (e) {
            console.warn('Could not parse phrases string:', e);
            return;
        }
    }
    
    // Check if it's an array
    if (!Array.isArray(phrases)) {
        console.warn('phrases is not an array:', phrases);
        return;
    }
    
    // Add phrase options
    phrases.forEach(phrase => {
        const option = document.createElement('div');
        option.className = 'trigger-option';
        option.textContent = phrase;
        option.addEventListener('click', function() {
            triggerSearch.value = phrase;
            triggerDropdown.style.display = 'none';
            updateCodePreview();
        });
        triggerDropdown.appendChild(option);
    });
    
    // Show dropdown if there are phrases
    if (phrases.length > 0 && triggerSearch === document.activeElement) {
        triggerDropdown.style.display = 'block';
    }
}

function initializeWithDefaults() {
    console.log('üöÄ INITIALIZING DATA SYSTEM...');
    
    // FIRST: Try to load from localStorage (user's saved data)
    const saved = localStorage.getItem('testimonialData');
    
    if (saved) {
        try {
            const savedData = JSON.parse(saved);
            
            // Check if saved data is valid
            if (savedData.industries && Object.keys(savedData.industries).length > 0) {
                currentData = savedData;
                console.log('‚úÖ Loaded user data from localStorage');
                console.log('   Industries:', Object.keys(savedData.industries));
                
                // Make sure we have required structures
                ensureDataStructure();
                return;
            } else {
                // Saved but empty - use defaults
                console.log('‚ö†Ô∏è localStorage empty, using defaults');
                useDefaultData();
            }
        } catch (e) {
            console.log('‚ùå Error loading from localStorage:', e);
            useDefaultData();
        }
    } else {
        // No localStorage data - use defaults
        console.log('üìÑ No localStorage data, using defaults');
        useDefaultData();
    }
    
    // Helper function for default data
    function useDefaultData() {
        currentData = {
            industries: {},
            videos: {},
            industryKeywords: {},
            universalConcerns: {
                price: { title: 'See The ROI Others Achieved', icon: 'üí∞', videoType: 'universal-price', reviews: [] },
                time: { title: 'For Busy Professionals', icon: '‚è∞', videoType: 'universal-time', reviews: [] },
                trust: { title: 'Proven Across Industries', icon: 'ü§ù', videoType: 'universal-trust', reviews: [] }
            },
            playerConfig: {
                desktop: { width: 854, height: 480, top: '50%', left: '50%', borderRadius: '12px' },
                mobile: { fullscreen: true },
                overlay: { background: 'rgba(0, 0, 0, 0.5)' },
                resumeMessage: "I'm sure you can appreciate what similar businesses have achieved..."
            }
        };
        
        // Check if testimonials-data.js has data
        if (window.testimonialData && window.testimonialData.industries) {
            console.log('üìÑ Merging data from testimonials-data.js...');
            
            // Merge industries from external file
            Object.keys(window.testimonialData.industries).forEach(slug => {
                if (!currentData.industries[slug]) {
                    currentData.industries[slug] = window.testimonialData.industries[slug];
                }
            });
            
            // Merge other data
            if (window.testimonialData.industryKeywords) {
                currentData.industryKeywords = window.testimonialData.industryKeywords;
            }
            if (window.testimonialData.videos) {
                currentData.videos = window.testimonialData.videos;
            }
        }
        
        console.log('üìÑ Initialized with default data structure');
    }
    
    // Ensure required structures exist
    function ensureDataStructure() {
        if (!currentData.industries) currentData.industries = {};
        if (!currentData.videos) currentData.videos = {};
        if (!currentData.industryKeywords) currentData.industryKeywords = {};
        if (!currentData.universalConcerns) {
            currentData.universalConcerns = {
                price: { title: 'See The ROI Others Achieved', icon: 'üí∞', videoType: 'universal-price', reviews: [] },
                time: { title: 'For Busy Professionals', icon: '‚è∞', videoType: 'universal-time', reviews: [] },
                trust: { title: 'Proven Across Industries', icon: 'ü§ù', videoType: 'universal-trust', reviews: [] }
            };
        }
        if (!currentData.playerConfig) {
            currentData.playerConfig = {
                desktop: { width: 854, height: 480, top: '50%', left: '50%', borderRadius: '12px' },
                mobile: { fullscreen: true },
                overlay: { background: 'rgba(0, 0, 0, 0.5)' },
                resumeMessage: "I'm sure you can appreciate what similar businesses have achieved..."
            };
        }
    }
    
    console.log('üöÄ INITIALIZATION COMPLETE');
    console.log('   Total industries:', Object.keys(currentData.industries).length);
}

function showIndustryManager() {
    const modalHTML = `
        <div class="modal" id="industryManagerModal" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üîß Industry Manager</h2>
                    <button class="close-modal" onclick="closeIndustryManager()">√ó</button>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.1);">
                                <th style="padding: 10px; text-align: left;">Icon</th>
                                <th style="padding: 10px; text-align: left;">Name</th>
                                <th style="padding: 10px; text-align: left;">Slug</th>
                                <th style="padding: 10px; text-align: left;">Concerns</th>
                                <th style="padding: 10px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="industryManagerList">
                            <!-- Industries will be listed here -->
                        </tbody>
                    </table>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="closeIndustryManager()" style="background: #666;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Populate the list
    populateIndustryManager();
}

function populateIndustryManager() {
    const tbody = document.getElementById('industryManagerList');
    tbody.innerHTML = '';
    
    Object.entries(currentData.industries).forEach(([slug, industry]) => {
        const concernCount = Object.keys(industry.concerns || {}).length;
        
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        row.innerHTML = `
            <td style="padding: 10px; font-size: 20px;">${industry.icon}</td>
            <td style="padding: 10px;">${industry.name}</td>
            <td style="padding: 10px; font-family: monospace; color: #888;">${slug}</td>
            <td style="padding: 10px;">${concernCount}</td>
            <td style="padding: 10px;">
                <button onclick="editIndustryInManager('${slug}')" style="background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                    ‚úèÔ∏è Edit
                </button>
                <button onclick="deleteIndustryInManager('${slug}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    üóëÔ∏è Delete
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function closeIndustryManager() {
    const modal = document.getElementById('industryManagerModal');
    if (modal) {
        modal.remove();
    }
}

function editIndustryInManager(slug) {
    closeIndustryManager();
    selectIndustry(slug);
    // You could also populate the edit modal here
}

function deleteIndustryInManager(slug) {
    if (!confirm(`Delete "${currentData.industries[slug].name}"? This cannot be undone.`)) {
        return;
    }
    
    delete currentData.industries[slug];
    delete currentData.industryKeywords[slug];
    
    if (currentIndustry === slug) {
        currentIndustry = null;
        document.getElementById('currentIndustryName').textContent = 'None selected';
    }
    
    updateIndustryList();
    updateStats();
    updateCodePreview();
    saveAllData();
    populateIndustryManager(); // Refresh the manager list
    
    showMessage(`‚úÖ Deleted industry`, 'success');
}
        
  function updateIndustryList() {
    console.log('updateIndustryList called');
    
    // ‚ö†Ô∏è SCROLL PROTECTION: Save current position
    const savedScroll = {
        x: window.scrollX,
        y: window.scrollY
    };
    
    const list = document.getElementById('industryList');
    if (!list) {
        console.error('industryList element not found');
        return;
    }
    
    // ‚ö†Ô∏è Use document fragment for single reflow
    const fragment = document.createDocumentFragment();
    
    Object.entries(currentData.industries).forEach(([slug, industry]) => {
        const li = document.createElement('li');
        li.className = `industry-item ${currentIndustry === slug ? 'active' : ''}`;
        
        // ‚ö†Ô∏è Create elements manually instead of innerHTML for better control
        const iconSpan = document.createElement('span');
        iconSpan.style.fontSize = '20px';
        iconSpan.textContent = industry.icon;
        
        const contentDiv = document.createElement('div');
        contentDiv.style.flex = '1';
        
        const nameDiv = document.createElement('div');
        nameDiv.style.fontWeight = '500';
        nameDiv.textContent = industry.name;
        
        const countDiv = document.createElement('div');
        countDiv.style.fontSize = '11px';
        countDiv.style.color = '#888';
        countDiv.textContent = `${Object.keys(industry.concerns || {}).length} concerns`;
        
        contentDiv.appendChild(nameDiv);
        contentDiv.appendChild(countDiv);
        
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-industry-btn';
        editBtn.dataset.slug = slug;
        editBtn.style.background = 'transparent';
        editBtn.style.border = 'none';
        editBtn.style.color = '#888';
        editBtn.style.cursor = 'pointer';
        editBtn.style.padding = '5px';
        editBtn.style.fontSize = '12px';
        editBtn.title = 'Edit this industry';
        editBtn.textContent = '‚úèÔ∏è';
        
        li.appendChild(iconSpan);
        li.appendChild(contentDiv);
        li.appendChild(editBtn);
        
        // Click to SELECT industry (main area)
        li.addEventListener('click', function(e) {
            // Don't trigger if clicking the edit button
            if (e.target.classList.contains('edit-industry-btn')) return;
            
            e.preventDefault();
            e.stopPropagation();
            selectIndustry(slug);
            return false;
        });
        
        // Edit button handler (small pencil icon)
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            editIndustry(slug);
            return false;
        });
        
        fragment.appendChild(li);
    });
    
    // ‚ö†Ô∏è Single DOM update
    list.innerHTML = '';
    list.appendChild(fragment);
    
    // ‚ö†Ô∏è Restore scroll position
    requestAnimationFrame(() => {
        window.scrollTo(savedScroll.x, savedScroll.y);
    });
    
    console.log('Industry list updated with', list.children.length, 'items');
}

// ===================================================
// üéØ UPDATE TESTIMONIALS GLANCE DISPLAY
// ===================================================

function updateTestimonialsGlance() {
    console.log('üëÅÔ∏è Updating testimonials glance...');
    
    if (!currentIndustry || !currentData.industries[currentIndustry]) {
        console.log('No industry selected');
        return;
    }
    
    const industry = currentData.industries[currentIndustry];
    const videos = industry.videos || {};
    const videoCount = Object.keys(videos).length;
    
    // Update testimonial count badge
    const countBadge = document.getElementById('testimonialCountBadge');
    if (countBadge) {
        countBadge.textContent = videoCount;
    }
    
    // Update industry icon
    const iconDisplay = document.getElementById('industryIconDisplay');
    if (iconDisplay && industry.icon) {
        iconDisplay.textContent = industry.icon;
    }
    
    // Count testimonials by type
    const typeCounts = {
        'price': 0,
        'time': 0,
        'trust': 0,
        'results': 0,
        'skeptical': 0,
        'speed': 0,
        'universal': 0
    };
    
    // Count by tags and video types
    Object.values(videos).forEach(video => {
        // Check video tags
        if (video.tags) {
            video.tags.forEach(tag => {
                const lowerTag = tag.toLowerCase();
                if (lowerTag.includes('price') || lowerTag.includes('cost')) typeCounts.price++;
                if (lowerTag.includes('time') || lowerTag.includes('busy')) typeCounts.time++;
                if (lowerTag.includes('trust') || lowerTag.includes('skeptical')) typeCounts.trust++;
                if (lowerTag.includes('result') || lowerTag.includes('success')) typeCounts.results++;
                if (lowerTag.includes('skeptical')) typeCounts.skeptical++;
                if (lowerTag.includes('speed') || lowerTag.includes('fast')) typeCounts.speed++;
            });
        }
        
        // Check video type
        if (video.videoType) {
            const type = video.videoType.toLowerCase();
            if (type.includes('price')) typeCounts.price++;
            if (type.includes('time') || type.includes('speed')) typeCounts.time++;
            if (type.includes('trust') || type.includes('skeptical')) typeCounts.trust++;
            if (type.includes('result') || type.includes('success')) typeCounts.results++;
        }
    });
    
    // Update the grid
    const grid = document.getElementById('testimonialTypesGrid');
    if (grid) {
        grid.innerHTML = `
            <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; border: 1px solid #bbdefb;">
                <div style="font-size: 20px;">üí∞</div>
                <div>Price</div>
                <div style="font-weight: bold; color: #1976d2;">${typeCounts.price}</div>
            </div>
            <div style="text-align: center; padding: 10px; background: #f3e5f5; border-radius: 6px; font-size: 12px; border: 1px solid #e1bee7;">
                <div style="font-size: 20px;">‚è∞</div>
                <div>Time</div>
                <div style="font-weight: bold; color: #7b1fa2;">${typeCounts.time}</div>
            </div>
            <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 12px; border: 1px solid #c8e6c9;">
                <div style="font-size: 20px;">ü§ù</div>
                <div>Trust</div>
                <div style="font-weight: bold; color: #388e3c;">${typeCounts.trust}</div>
            </div>
            <div style="text-align: center; padding: 10px; background: #fff3e0; border-radius: 6px; font-size: 12px; border: 1px solid #ffe0b2;">
                <div style="font-size: 20px;">üìà</div>
                <div>Results</div>
                <div style="font-weight: bold; color: #f57c00;">${typeCounts.results}</div>
            </div>
            ${typeCounts.skeptical > 0 ? `
            <div style="text-align: center; padding: 10px; background: #ffebee; border-radius: 6px; font-size: 12px; border: 1px solid #ffcdd2; grid-column: span 2;">
                <div style="font-size: 20px;">ü§î</div>
                <div>Skeptical/Concerns</div>
                <div style="font-weight: bold; color: #d32f2f;">${typeCounts.skeptical}</div>
            </div>
            ` : ''}
        `;
    }
    
    // Update recent testimonials list
    updateRecentTestimonialsList();
}

function updateRecentTestimonialsList() {
    const container = document.getElementById('recentTestimonialsList');
    if (!container || !currentIndustry || !currentData.industries[currentIndustry]) return;
    
    const videos = currentData.industries[currentIndustry].videos || {};
    const videoEntries = Object.entries(videos);
    
    if (videoEntries.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #6c757d; font-style: italic;">
                No testimonials yet. Add your first one!
            </div>
        `;
        return;
    }
    
    // Get 5 most recent (or all if less than 5)
    const recentVideos = videoEntries.slice(-5).reverse();
    
    container.innerHTML = recentVideos.map(([videoId, video]) => `
        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 40px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                ${getVideoIcon(video)}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 13px; color: #333;">${video.title || 'Untitled'}</div>
                <div style="font-size: 11px; color: #6c757d;">
                    ${(video.tags || []).slice(0, 2).join(', ')}${(video.tags || []).length > 2 ? '...' : ''}
                </div>
            </div>
            <button class="btn" onclick="playTestimonial('${videoId}')" 
                    style="background: none; border: none; color: #007bff; font-size: 20px; cursor: pointer; padding: 0;">
                ‚ñ∂Ô∏è
            </button>
        </div>
    `).join('');
}

function getVideoIcon(video) {
    if (video.videoType) {
        const type = video.videoType.toLowerCase();
        if (type.includes('price')) return 'üí∞';
        if (type.includes('time')) return '‚è∞';
        if (type.includes('trust') || type.includes('skeptical')) return 'ü§ù';
        if (type.includes('speed')) return '‚ö°';
    }
    
    if (video.tags) {
        if (video.tags.some(t => t.toLowerCase().includes('price'))) return 'üí∞';
        if (video.tags.some(t => t.toLowerCase().includes('time'))) return '‚è∞';
        if (video.tags.some(t => t.toLowerCase().includes('trust'))) return 'ü§ù';
    }
    
    return 'üé¨';
}

function playTestimonial(videoId) {
    console.log('Playing testimonial:', videoId);
    // You can implement your video player here
    alert(`Play video: ${videoId}`);
}

function showAllTestimonials() {
    console.log('Show all testimonials');
    // Scroll to testimonials section or open modal
    const testimonialsSection = document.querySelector('.testimonials-section');
    if (testimonialsSection) {
        testimonialsSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// Call this when industry changes or testimonials are added
function refreshTestimonialsDisplay() {
    updateTestimonialsGlance();
    updateRecentTestimonialsList();
}

// Add to your existing update functions
function enhanceUpdateFunctions() {
    // Wrap existing selectIndustry function
    const originalSelectIndustry = window.selectIndustry;
    window.selectIndustry = function(slug) {
        originalSelectIndustry(slug);
        setTimeout(() => {
            refreshTestimonialsDisplay();
        }, 100);
    };
    
    // Call after page loads
    setTimeout(() => {
        refreshTestimonialsDisplay();
    }, 1000);
}

// Initialize
enhanceUpdateFunctions();

function addIndustry() {
    console.log('üéØ ADD INDUSTRY (ONE-INDUSTRY MODE)...');
    
    // Get form values
    const name = document.getElementById('newIndustryName').value.trim();
    const slug = document.getElementById('newIndustrySlug').value.trim();
    const keywordsText = document.getElementById('newIndustryKeywords').value.trim();
    const icon = document.getElementById('newIndustryIcon').value.trim() || 'üè¢';
    
    // Validate
    if (!name) {
        showMessage('Please enter industry name', 'error');
        return;
    }
    
    // üéØ ONLY ONE INDUSTRY ALLOWED
    const existingIndustries = Object.keys(currentData.industries || {});
    if (existingIndustries.length >= 1) {
        const currentIndustryName = Object.values(currentData.industries)[0]?.name || 'Unknown';
        
        if (!confirm(`‚ö†Ô∏è ONE-INDUSTRY LIMIT\n\nYou already have: "${currentIndustryName}"\n\nDo you want to REPLACE it with: "${name}"?`)) {
            return;
        }
        
        // Clear existing industry
        currentData.industries = {};
        currentData.industryKeywords = {};
        console.log('üßπ Cleared existing industry to make room for new one');
    }
    
    // Generate slug if empty
    const finalSlug = slug || name.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, '-')
        .replace(/--+/g, '-');
    
    // Convert keywords to array
    let concerns = [];
    if (keywordsText) {
        concerns = keywordsText.split(',')
            .map(c => c.trim())
            .filter(c => c.length > 0);
    }
    
    // üéØ AUTO-ADD POSITIVE TRIGGERS
    const positiveTriggers = [
        'compare with others',
        'how do you compare',
        'better than competitors',
        'success stories', 
        'positive results',
        'why choose you',
        'benefits',
        'advantages',
        'reconfirming positives'
    ];
    
    // Combine user concerns with positive triggers
    concerns = [...new Set([...concerns, ...positiveTriggers])];
    
    // Create the ONE industry
    currentData.industries[finalSlug] = {
        name: name,
        icon: icon,
        concerns: concerns,
        videos: {}
    };
    
    currentData.industryKeywords[finalSlug] = concerns;
    
    // Auto-select it
    selectIndustry(finalSlug);
    
    // Close modal and reset form
    $('#addIndustryModal').modal('hide');
    document.getElementById('newIndustryName').value = '';
    document.getElementById('newIndustrySlug').value = '';
    document.getElementById('newIndustryKeywords').value = '';
    document.getElementById('newIndustryIcon').value = 'üè¢';
    
    // Update UI
    updateIndustryList();
    updateStats();
    saveAllData();
    
    showMessage(`‚úÖ ONE Industry Set: ${icon} ${name}`, 'success');
    console.log('‚úÖ ONE industry set:', { name, concerns: concerns.length });
}

function hideAddIndustryModal() {
    document.getElementById('addIndustryModal').style.display = 'none';
    
    // Reset the form fields
    document.getElementById('newIndustryName').value = '';
    document.getElementById('newIndustrySlug').value = '';
    document.getElementById('newIndustryIcon').value = 'üè¢';
    document.getElementById('newIndustryKeywords').value = '';
    
    // Reset the modal title if it was changed
    const modalTitle = document.querySelector('#addIndustryModal h2');
    if (modalTitle) {
        modalTitle.textContent = 'üè¢ Add New Industry';
    }
    
    // Reset the submit button text and handler
    const submitBtn = document.querySelector('#addIndustryModal .btn-success');
    if (submitBtn) {
        submitBtn.textContent = '‚úÖ Add Industry';
        submitBtn.onclick = function() { addIndustry(); };
    }
    
    console.log('Industry modal closed');
}

// Initialize the modal's trigger system when modal opens
function showAddIndustryModal() {
    console.log('showAddIndustryModal called');
    
    // Show the modal
    document.getElementById('addIndustryModal').style.display = 'flex';
    
    // Initialize modal's trigger search if needed
    const modalTriggerSearch = document.querySelector('#addIndustryModal #trigger-search');
    if (modalTriggerSearch && typeof initModalTriggerSystem === 'undefined') {
        initModalTriggerSystem();
    }
    
    // Focus on the first input field
    setTimeout(() => {
        document.getElementById('newIndustryName').focus();
    }, 100);
}

// ==============================================
// AUTO-SLUG GENERATION (UPDATED WITH CORRECT IDs)
// ==============================================

document.getElementById('addIndustryModal').addEventListener('shown.bs.modal', function() {
    const nameInput = this.querySelector('#newIndustryName');
    const slugInput = this.querySelector('#newIndustrySlug');
    
    if (nameInput && slugInput) {
        // Generate slug when industry name changes
        nameInput.addEventListener('input', function() {
            if (!slugInput.dataset.manualEdit) {
                const slug = this.value
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                slugInput.value = slug;
            }
        });
        
        // Mark as manually edited
        slugInput.addEventListener('input', function() {
            if (this.value.trim()) {
                this.dataset.manualEdit = 'true';
            }
        });
    }
});

// Reset on modal close
document.getElementById('addIndustryModal').addEventListener('hidden.bs.modal', function() {
    const slugInput = this.querySelector('#newIndustrySlug');
    if (slugInput && slugInput.dataset.manualEdit) {
        delete slugInput.dataset.manualEdit;
    }
});

// ==============================================
// KEYWORD SUGGESTIONS FOR INDUSTRY FORM
// ==============================================

document.getElementById('addIndustryModal').addEventListener('shown.bs.modal', function() {
    const nameInput = this.querySelector('#newIndustryName');
    const keywordsInput = this.querySelector('#newIndustryKeywords');
    
    if (nameInput && keywordsInput) {
        const keywordLibrary = {
            'attorney': ['legal', 'lawyer', 'case', 'injury', 'lawsuit'],
            'mortgage': ['loan', 'refinance', 'interest', 'home', 'approval'],
            'real estate': ['agent', 'property', 'home', 'sale', 'buyer'],
            'medical': ['doctor', 'treatment', 'healthcare', 'procedure'],
            'financial': ['advisor', 'investment', 'retirement', 'planning'],
            'insurance': ['coverage', 'policy', 'claim', 'protection']
        };
        
        nameInput.addEventListener('blur', function() {
            if (!keywordsInput.value.trim()) {
                const industryName = this.value.toLowerCase();
                const suggestions = new Set();
                
                Object.entries(keywordLibrary).forEach(([category, keywords]) => {
                    if (industryName.includes(category)) {
                        keywords.forEach(keyword => suggestions.add(keyword));
                    }
                });
                
                ['consultation', 'services', 'professional'].forEach(word => 
                    suggestions.add(word)
                );
                
                if (suggestions.size > 0) {
                    const suggestionArray = Array.from(suggestions);
                    keywordsInput.placeholder = `e.g., ${suggestionArray.slice(0, 3).join(', ')}...`;
                }
            }
        });
    }
});

// ==============================================
// AUTO-POPULATE CONCERNKEYWORDS FROM CONCERNS
// ==============================================
// This is the MAIN functionality - when checkboxes are checked,
// their phrases go into #concernKeywords field

function setupConcernKeywordsLinking() {
    console.log('üîó Setting up concern-to-keywords linking...');
    
    const concernKeywordsField = document.getElementById('concernKeywords');
    const concernsContainer = document.getElementById('concerns-container');
    
    if (!concernKeywordsField) {
        console.log('‚ùå #concernKeywords field not found');
        return;
    }
    
    if (!concernsContainer) {
        console.log('‚ùå #concerns-container not found');
        return;
    }
    
    console.log('‚úÖ Found #concernKeywords and #concerns-container');
    
    // Listen for checkbox changes
    concernsContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('concern-checkbox')) {
            const checkbox = e.target;
            const concernValue = checkbox.value;
            
            console.log(`Checkbox "${concernValue}" changed: ${checkbox.checked}`);
            
            try {
                // Get and parse phrases
                const rawData = checkbox.dataset.phrases || '[]';
                const unescaped = rawData
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'");
                const phrases = JSON.parse(unescaped);
                
                console.log(`  Parsed ${phrases.length} phrases:`, phrases);
                
                const currentKeywords = concernKeywordsField.value.trim();
                
                if (checkbox.checked) {
                    // ADD phrases
                    if (currentKeywords === '') {
                        concernKeywordsField.value = phrases.join(', ');
                        console.log(`‚úÖ Set keywords: ${phrases.join(', ')}`);
                    } else {
                        const existing = currentKeywords.split(',').map(p => p.trim());
                        const toAdd = phrases.filter(p => !existing.includes(p));
                        
                        if (toAdd.length > 0) {
                            concernKeywordsField.value = currentKeywords + ', ' + toAdd.join(', ');
                            console.log(`‚úÖ Added: ${toAdd.join(', ')}`);
                        }
                    }
                } else {
                    // REMOVE phrases
                    if (currentKeywords) {
                        const currentPhrases = currentKeywords.split(',').map(p => p.trim());
                        const remaining = currentPhrases.filter(p => !phrases.includes(p));
                        concernKeywordsField.value = remaining.join(', ');
                        console.log(`‚ùå Removed: ${phrases.join(', ')}`);
                    }
                }
                
                // Visual feedback
                concernKeywordsField.style.border = '2px solid #4CAF50';
                concernKeywordsField.style.backgroundColor = '#f0fff0';
                setTimeout(() => {
                    concernKeywordsField.style.border = '';
                    concernKeywordsField.style.backgroundColor = '';
                }, 1000);
                
                // Update code preview if function exists
                if (typeof updateCodePreview === 'function') {
                    updateCodePreview();
                }
                
            } catch (error) {
                console.log(`‚ùå Error processing ${concernValue}:`, error);
            }
        }
    });
    
    console.log('‚úÖ Concern-to-keywords linking setup complete');
}

// Initialize
document.addEventListener('DOMContentLoaded', setupConcernKeywordsLinking);

// Initialize the modal's trigger system (separate from main form)
function initModalTriggerSystem() {
    console.log('Initializing modal trigger system...');
    
    const modalTriggerSearch = document.querySelector('#addIndustryModal #trigger-search');
    const modalTriggerDropdown = document.querySelector('#addIndustryModal #trigger-dropdown');
    
    if (!modalTriggerSearch || !modalTriggerDropdown) return;
    
    // This is for the MODAL - different from main form
    modalTriggerSearch.addEventListener('focus', function() {
        // Load template triggers for the modal
        if (typeof loadTriggerTemplates === 'function') {
            loadTriggerTemplates();
            modalTriggerDropdown.style.display = 'block';
        }
    });
    
    console.log('‚úÖ Modal trigger system initialized');
}

function editIndustry(slug) {
    console.log('Editing industry:', slug);
    
    const industry = currentData.industries[slug];
    if (!industry) {
        showMessage('Industry not found', 'error');
        return;
    }
    
    // Populate the modal with existing data
    document.getElementById('newIndustryName').value = industry.name;
    document.getElementById('newIndustrySlug').value = slug;
    document.getElementById('newIndustryIcon').value = industry.icon;
    document.getElementById('newIndustryKeywords').value = 
        (currentData.industryKeywords[slug] || []).join(', ');
    
    // Change button to "Update" instead of "Add"
    const submitBtn = document.querySelector('#addIndustryModal .btn-success');
    if (submitBtn) {
        submitBtn.textContent = '‚úÖ Update Industry';
        submitBtn.onclick = function() { updateIndustry(slug); };
    }
    
    // Store which industry we're editing
    window.editingIndustry = slug;
    
    // Show the modal
    document.getElementById('addIndustryModal').style.display = 'flex';
    document.getElementById('newIndustryName').focus();
}

function updateIndustry(slug) {
    const name = document.getElementById('newIndustryName').value.trim();
    const newSlug = document.getElementById('newIndustrySlug').value.trim()
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '');
    const icon = document.getElementById('newIndustryIcon').value.trim();
    const keywords = document.getElementById('newIndustryKeywords').value
        .split(',')
        .map(k => k.trim())
        .filter(k => k);
    
    if (!name || !newSlug) {
        showMessage('Please enter industry name and slug', 'error');
        return;
    }
    
    // If slug changed, check if new slug already exists
    if (newSlug !== slug && currentData.industries[newSlug]) {
        showMessage(`Slug "${newSlug}" already exists. Choose a different one.`, 'error');
        return;
    }
    
    // Get the old industry data
    const oldIndustry = currentData.industries[slug];
    
    // If slug changed, we need to move data
    if (newSlug !== slug) {
        // 1. Copy industry to new slug
        currentData.industries[newSlug] = {
            ...oldIndustry,
            name: name,
            icon: icon
        };
        
        // 2. Copy keywords
        currentData.industryKeywords[newSlug] = keywords;
        
        // 3. Update video keys that start with old slug
        Object.keys(currentData.videos).forEach(videoKey => {
            if (videoKey.startsWith(slug + '-')) {
                const newVideoKey = videoKey.replace(slug + '-', newSlug + '-');
                currentData.videos[newVideoKey] = currentData.videos[videoKey];
                delete currentData.videos[videoKey];
            }
        });
        
        // 4. Update concern videoType references
        if (currentData.industries[newSlug].concerns) {
            Object.values(currentData.industries[newSlug].concerns).forEach(concern => {
                if (concern.videoType && concern.videoType.startsWith(slug + '-')) {
                    concern.videoType = concern.videoType.replace(slug + '-', newSlug + '-');
                }
            });
        }
        
        // 5. Delete old industry
        delete currentData.industries[slug];
        delete currentData.industryKeywords[slug];
        
        // 6. Update currentIndustry if it was this one
        if (currentIndustry === slug) {
            currentIndustry = newSlug;
        }
        
    } else {
        // Just update existing industry
        currentData.industries[slug].name = name;
        currentData.industries[slug].icon = icon;
        currentData.industryKeywords[slug] = keywords;
    }
    
    // Close modal and reset
    hideAddIndustryModal();
    updateIndustryList();
    updateStats();
    updateCodePreview();
    saveAllData();
    
    showMessage(`‚úÖ Updated industry: ${name}`, 'success');
    
    // Reset the button back to "Add"
    const submitBtn = document.querySelector('#addIndustryModal .btn-success');
    if (submitBtn) {
        submitBtn.textContent = '‚úÖ Add Industry';
        submitBtn.onclick = function() { addIndustry(); };
    }
    
    delete window.editingIndustry;
}

function selectIndustry(slug) {
    console.log('selectIndustry called with:', slug);
    
    // 1. VALIDATION
    if (!slug) {
        console.error('No slug provided');
        return;
    }
    
    if (!currentData || !currentData.industries) {
        console.error('Current data not initialized');
        showMessage('System not initialized properly', 'error');
        return;
    }
    
    const industry = currentData.industries[slug];
    if (!industry) {
        console.error('Industry not found:', slug);
        showMessage(`Industry "${slug}" not found`, 'error');
        return;
    }
    
    // 2. UPDATE CURRENT INDUSTRY
    currentIndustry = slug;
    
    // 3. UPDATE UI
    updateIndustryList(); // This highlights the active item
    
    // Update the top display
    const currentIndustryEl = document.getElementById('currentIndustryName');
    if (currentIndustryEl) {
        currentIndustryEl.textContent = `${industry.icon} ${industry.name}`;
    }
    
    // Hide industry select group if shown
    document.getElementById('industrySelectGroup').style.display = 'none';
    
    // 4. UPDATE CONCERN DROPDOWN (MISSING IN YOUR VERSION!)
    updateConcernDropdown();

    // 5. LOAD TRIGGERS FOR THIS INDUSTRY - ADD THIS!
    if (typeof loadTriggerTemplates === 'function') {
        loadTriggerTemplates();
    }
    if (typeof filterTriggers === 'function') {
        filterTriggers('all');
    }
    
    // 7. UPDATE CODE PREVIEW
    updateCodePreview();
    
    // 8. SHOW SUCCESS MESSAGE
    showMessage(`‚úÖ Selected: ${industry.name}`, 'success');
    
    console.log('Industry selection complete:', industry.name);
}

// ADD THIS FUNCTION IF IT DOESN'T EXIST:
function updateConcernDropdown() {
    const concernSelect = document.getElementById('concernType');
    if (!concernSelect) return;
    
    concernSelect.innerHTML = '<option value="">Select a concern</option>';
    
    if (!currentIndustry) return;
    
    const industry = currentData.industries[currentIndustry];
    if (industry && industry.concerns) {
        Object.keys(industry.concerns).forEach(concernKey => {
            const concern = industry.concerns[concernKey];
            const option = document.createElement('option');
            option.value = concernKey;
            option.textContent = `${concern.icon} ${concern.title}`;
            concernSelect.appendChild(option);
        });
    }
    
    // Add "New Concern" option
    const newOption = document.createElement('option');
    newOption.value = 'new';
    newOption.textContent = '‚ûï Create New Concern';
    concernSelect.appendChild(newOption);
}
        // ===================================================
// SUPABASE VIDEO MANAGEMENT
// ===================================================
function openSupabaseUploader() {
    // Open the correct Supabase Storage dashboard URL
    const supabaseUrl = 'https://supabase.com/dashboard/project/odetjszursuaxpapfwcy/storage/files/buckets/video-avatars';
    
    // Open in new tab
    const newWindow = window.open(supabaseUrl, '_blank');
    
    if (!newWindow) {
        showMessage('‚ùå Popup blocked! Please allow popups for this site or manually visit: ' + supabaseUrl, 'error');
        return;
    }
    
    showMessage('üì§ Opened Supabase Storage. Upload your video there, then copy the public URL.', 'success');
    
    // Provide detailed instructions
    setTimeout(() => {
        const instructions = `
üé¨ SUPABASE UPLOAD INSTRUCTIONS:

1. In the new Supabase tab, click the "Upload file" button
2. Select your testimonial video file (MP4 format works best)
3. Wait for upload to complete (green checkmark appears)
4. Find your uploaded file in the list
5. Click the three dots (...) menu on your file
6. Select "Get public URL" from the menu
7. Copy the URL that appears (it should look like this):

   üîó https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/your-video.mp4

8. Return to this tab and paste the URL in the "Supabase Video URL" field
9. Click "Test URL" button to preview the video
10. Fill in the concern details
11. Click "Add Video Testimonial"

üí° TIP: Name your video files descriptively, like:
   - personal-injury-case-screening.mp4
   - mortgage-prequalification.mp4
   - dental-new-patient.mp4
        `;
        
        // Create a styled instruction modal
        const instructionModal = document.createElement('div');
        instructionModal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            color: white;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--primary);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        `;
        
        instructionModal.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin: 0;">üìã Upload Instructions</h3>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div style="line-height: 1.6; color: #ccc;">
                ${instructions.replace(/\n/g, '<br>')}
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="this.parentElement.parentElement.remove()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Got it! I'll upload now
                </button>
            </div>
        `;
        
        document.body.appendChild(instructionModal);
    }, 1000);
}
        
        function testVideoUrl() {
            const urlInput = document.getElementById('videoUrl').value.trim();
            
            if (!urlInput) {
                showMessage('Please enter a video URL', 'error');
                return;
            }
            
            // Validate URL format
            if (!urlInput.startsWith('http')) {
                showMessage('Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }
            
            // Extract video key from URL
            const videoKey = extractVideoKeyFromUrl(urlInput);
            
            if (!videoKey) {
                showMessage('Could not extract video key from URL. Make sure it\'s a valid Supabase URL.', 'error');
                return;
            }
            
            // Show preview
            const previewVideo = document.getElementById('previewVideo');
            const videoPreview = document.getElementById('videoPreview');
            const videoKeyDisplay = document.getElementById('videoKeyDisplay');
            const videoStatus = document.getElementById('videoStatus');
            
            // Test if video loads
            previewVideo.src = urlInput;
            previewVideo.load();
            
            previewVideo.onloadeddata = () => {
                videoKeyDisplay.textContent = videoKey;
                videoStatus.textContent = '‚úÖ Ready to add';
                videoStatus.style.color = 'var(--success)';
                videoPreview.style.display = 'block';
                currentVideoKey = videoKey;
                
                // Auto-fill concern name if empty
                const concernInput = document.getElementById('concernName');
                if (!concernInput.value.trim()) {
                    // Try to extract concern from video key
                    const concernFromKey = videoKey.split('-').slice(1).join('-');
                    if (concernFromKey) {
                        concernInput.value = concernFromKey;
                        
                        // Also auto-fill title
                        const titleInput = document.getElementById('concernTitle');
                        if (!titleInput.value.trim()) {
                            titleInput.value = concernFromKey.split('-')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                        }
                    }
                }
                
                showMessage(`‚úÖ URL validated! Video key: ${videoKey}`, 'success');
            };
            
            previewVideo.onerror = () => {
                videoStatus.textContent = '‚ùå Video failed to load';
                videoStatus.style.color = 'var(--danger)';
                videoPreview.style.display = 'block';
                showMessage('‚ö†Ô∏è URL is valid but video failed to load. Check if the file is public in Supabase.', 'warning');
            };
        }
        
        function extractVideoKeyFromUrl(url) {
            try {
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/');
                const filename = pathParts[pathParts.length - 1];
                
                if (!filename) {
                    return null;
                }
                
                // Remove extension
                const withoutExt = filename.replace(/\.[^/.]+$/, '');
                
                // Clean up common patterns
                const cleanKey = withoutExt
                    .replace(/^video_avatar_/, '')
                    .replace(/^testimonial_/, '')
                    .replace(/_\d+$/, '') // Remove timestamps
                    .replace(/[^a-zA-Z0-9-]/g, '-') // Replace special chars with hyphens
                    .replace(/-+/g, '-') // Remove multiple hyphens
                    .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
                
                return cleanKey || 'video-testimonial';
            } catch (e) {
                console.error('Error parsing URL:', e);
                return null;
            }
        }
        
        // ===================================================
        // TESTIMONIAL MANAGEMENT
        // ===================================================
        function addVideoTestimonial() {
            const concernName = document.getElementById('concernName').value.trim();
            const concernTitle = document.getElementById('concernTitle').value.trim();
            const concernIcon = document.getElementById('concernIcon').value.trim() || 'üéØ';
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const textTestimonial = document.getElementById('textTestimonial').value.trim();
            const authorName = document.getElementById('authorName').value.trim();
            
            // Determine which industry to use
            let targetIndustry = currentIndustry;
            
            // If no industry selected, show dropdown
            if (!targetIndustry) {
                document.getElementById('industrySelectGroup').style.display = 'block';
                updateIndustryDropdown();
                showMessage('Please select an industry first', 'error');
                return;
            }
            
            // Validate required fields
            if (!concernName) {
                showMessage('Please enter a concern name', 'error');
                document.getElementById('concernName').focus();
                return;
            }
            
            if (!concernTitle) {
                showMessage('Please enter a concern title', 'error');
                document.getElementById('concernTitle').focus();
                return;
            }
            
            if (!videoUrl) {
                showMessage('Please enter a video URL', 'error');
                document.getElementById('videoUrl').focus();
                return;
            }
            
            const concernKey = concernName.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            
            // Use extracted video key or generate one
            const videoKey = currentVideoKey || `${targetIndustry}-${concernKey}`;
            
            // Ensure industry exists in data
            if (!currentData.industries[targetIndustry]) {
                showMessage(`Industry "${targetIndustry}" not found in data`, 'error');
                return;
            }
            
            // Ensure industry has concerns object
            if (!currentData.industries[targetIndustry].concerns) {
                currentData.industries[targetIndustry].concerns = {};
            }
            
            // Create or update concern
            if (!currentData.industries[targetIndustry].concerns[concernKey]) {
                currentData.industries[targetIndustry].concerns[concernKey] = {
                    title: concernTitle,
                    icon: concernIcon,
                    videoType: videoKey,
                    reviews: []
                };
            } else {
                // Update existing concern
                currentData.industries[targetIndustry].concerns[concernKey].title = concernTitle;
                currentData.industries[targetIndustry].concerns[concernKey].icon = concernIcon;
                currentData.industries[targetIndustry].concerns[concernKey].videoType = videoKey;
            }
            
            // Add video URL to videos object
            currentData.videos[videoKey] = videoUrl;
            
            // Add text testimonial if provided
            if (textTestimonial && authorName) {
                currentData.industries[targetIndustry].concerns[concernKey].reviews.push({
                    text: textTestimonial,
                    author: authorName
                });
            }
            
            // Clear form
            clearForm();
            
            // Update displays
            updateCodePreview();
            updateStats();
            showMessage(`‚úÖ Added video testimonial to ${currentData.industries[targetIndustry].name}`, 'success');
            saveAllData();
        }
        
        function addTextOnlyTestimonial() {
            const concernName = document.getElementById('concernName').value.trim();
            const concernTitle = document.getElementById('concernTitle').value.trim();
            const concernIcon = document.getElementById('concernIcon').value.trim() || 'üí¨';
            const textTestimonial = document.getElementById('textTestimonial').value.trim();
            const authorName = document.getElementById('authorName').value.trim();
            
            // Determine which industry to use
            let targetIndustry = currentIndustry;
            
            if (!targetIndustry) {
                document.getElementById('industrySelectGroup').style.display = 'block';
                updateIndustryDropdown();
                showMessage('Please select an industry first', 'error');
                return;
            }
            
            // Validate required fields
            if (!concernName || !concernTitle || !textTestimonial || !authorName) {
                showMessage('Please fill in all fields for text testimonial', 'error');
                return;
            }
            
            const concernKey = concernName.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            
            // Ensure industry exists
            if (!currentData.industries[targetIndustry]) {
                showMessage(`Industry "${targetIndustry}" not found`, 'error');
                return;
            }
            
            // Ensure industry has concerns object
            if (!currentData.industries[targetIndustry].concerns) {
                currentData.industries[targetIndustry].concerns = {};
            }
            
            // Create or update concern
            if (!currentData.industries[targetIndustry].concerns[concernKey]) {
                currentData.industries[targetIndustry].concerns[concernKey] = {
                    title: concernTitle,
                    icon: concernIcon,
                    videoType: '', // No video for text-only
                    reviews: []
                };
            }
            
                        // Add text testimonial
            currentData.industries[targetIndustry].concerns[concernKey].reviews.push({
                text: textTestimonial,
                author: authorName
            });
            
            // Clear form
            clearForm();
            
            // Update displays
            updateCodePreview();
            updateStats();
            showMessage(`‚úÖ Added text testimonial to ${currentData.industries[targetIndustry].name}`, 'success');
            saveAllData();
        }
        
        function clearForm() {
            document.getElementById('concernName').value = '';
            document.getElementById('concernTitle').value = '';
            document.getElementById('concernIcon').value = 'üéØ';
            document.getElementById('videoUrl').value = '';
            document.getElementById('textTestimonial').value = '';
            document.getElementById('authorName').value = '';
            document.getElementById('videoPreview').style.display = 'none';
            currentVideoKey = null;
        }
        
        function updateIndustryDropdown() {
            const dropdown = document.getElementById('selectIndustryDropdown');
            dropdown.innerHTML = '<option value="">-- Select Industry --</option>';
            
            Object.entries(currentData.industries).forEach(([slug, industry]) => {
                const option = document.createElement('option');
                option.value = slug;
                option.textContent = `${industry.icon} ${industry.name}`;
                dropdown.appendChild(option);
            });
        }

        // NEW FUNCTION: Update the testimonials-data.js file
function updateTestimonialsDataFile() {
    console.log('üìù Updating testimonials-data.js file...');
    
    const dataToSave = {
        currentIndustry: currentIndustry,
        industries: currentData.industries,
        industryKeywords: currentData.industryKeywords,
        videos: currentData.videos,
        universalConcerns: currentData.universalConcerns,
        playerConfig: currentData.playerConfig
    };
    
    // Create the file content
    const fileContent = `window.testimonialData = ${JSON.stringify(dataToSave, null, 2)};`;
    
    // Create a download link (for testing)
    const blob = new Blob([fileContent], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'testimonials-data.js';
    a.textContent = 'üì• Download updated testimonials-data.js';
    a.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 99999;
    `;
    document.body.appendChild(a);
    
    console.log('‚úÖ Created updated testimonials-data.js file');
    console.log('   Click the green download button to save it');
    console.log('   Replace your current testimonials-data.js with this file');
    
    return fileContent;
}
        
        // ===================================================
        // CODE GENERATION & EXPORT
        // ===================================================
        function updateCodePreview() {
            const codeOutput = document.getElementById('codeOutput');
            
            // Create clean export data
            const exportData = {
                industries: JSON.parse(JSON.stringify(currentData.industries)),
                videos: currentData.videos,
                universalConcerns: currentData.universalConcerns,
                industryKeywords: currentData.industryKeywords,
                playerConfig: currentData.playerConfig
            };
            
            // Generate the JS code
            const jsCode = generateJSCode(exportData);
            codeOutput.textContent = jsCode;
            
            // Simple syntax highlighting
            const highlighted = jsCode
                .replace(/("[^"]*":)/g, '<span style="color: #569CD6;">$1</span>')
                .replace(/(true|false|null|undefined)/g, '<span style="color: #569CD6;">$1</span>')
                .replace(/(\d+)/g, '<span style="color: #B5CEA8;">$1</span>')
                .replace(/("[^"]*")/g, '<span style="color: #CE9178;">$1</span>')
                .replace(/(\/\/.*$)/gm, '<span style="color: #6A9955;">$1</span>');
            
            codeOutput.innerHTML = highlighted;
        }
        
        function generateJSCode(data) {
            const date = new Date().toLocaleString();
            return `// ===================================================
// üéØ MOBILE-WISE AI TESTIMONIALS DATA
// Generated: ${date}
// Total Industries: ${Object.keys(data.industries).length}
// Total Videos: ${Object.keys(data.videos).length}
// ===================================================

window.testimonialData = ${JSON.stringify(data, null, 2)};

console.log('‚úÖ Testimonials Data Loaded:', Object.keys(window.testimonialData.industries).length, 'industries');
console.log('üé¨ Videos Available:', Object.keys(window.testimonialData.videos).length);
console.log('üè¢ Industry Keywords:', Object.keys(window.testimonialData.industryKeywords).length);`;
        }
        
        function copyCode() {
            const exportData = {
                industries: JSON.parse(JSON.stringify(currentData.industries)),
                videos: currentData.videos,
                universalConcerns: currentData.universalConcerns,
                industryKeywords: currentData.industryKeywords,
                playerConfig: currentData.playerConfig
            };
            
            const code = generateJSCode(exportData);
            
            navigator.clipboard.writeText(code)
                .then(() => showMessage('‚úÖ Code copied to clipboard!', 'success'))
                .catch(err => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = code;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showMessage('‚úÖ Code copied to clipboard!', 'success');
                });
        }
        
        function downloadJSFile() {
            const exportData = {
                industries: JSON.parse(JSON.stringify(currentData.industries)),
                videos: currentData.videos,
                universalConcerns: currentData.universalConcerns,
                industryKeywords: currentData.industryKeywords,
                playerConfig: currentData.playerConfig
            };
            
            const code = generateJSCode(exportData);
            const blob = new Blob([code], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'testimonials-data.js';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ testimonials-data.js downloaded!', 'success');
        }
        
        // ===================================================
        // UTILITY FUNCTIONS
        // ===================================================
        function updateStats() {
    // Safely get counts with null checks
    const industries = Object.keys(currentData.industries || {}).length;
    const videos = Object.keys(currentData.videos || {}).length;
    
    let concerns = 0;
    let testimonials = 0;
    
    // Safely iterate through industries
    if (currentData.industries) {
        Object.values(currentData.industries).forEach(industry => {
            if (industry && industry.concerns) {
                concerns += Object.keys(industry.concerns).length;
                
                // Safely count testimonials
                Object.values(industry.concerns).forEach(concern => {
                    if (concern && concern.reviews) {
                        testimonials += concern.reviews.length;
                    }
                });
            }
        });
    }
    
    // Add universal concerns testimonials
    if (currentData.universalConcerns) {
        Object.values(currentData.universalConcerns).forEach(concern => {
            if (concern && concern.reviews) {
                testimonials += concern.reviews.length;
            }
        });
    }
    
    // Update the display
    document.getElementById('statIndustries').textContent = industries;
    document.getElementById('statVideos').textContent = videos;
    document.getElementById('statConcerns').textContent = concerns;
    document.getElementById('statTestimonials').textContent = testimonials;
}
        
        function showMessage(text, type) {
            const messageEl = document.getElementById(`${type}Message`);
            
            messageEl.textContent = text;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';
            
            // Scroll to message
            messageEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-hide success/warning messages
            if (type !== 'error') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 4000);
            }
        }
        
        function saveAllData() {
    console.log('üíæ SAVING DATA...');
    
    // Make sure currentIndustry is set
    if (!currentIndustry && Object.keys(currentData.industries).length > 0) {
        currentIndustry = Object.keys(currentData.industries)[0];
        console.log('   Auto-set currentIndustry to:', currentIndustry);
    }
    
    try {
        // 1. Save to localStorage
        localStorage.setItem('testimonialData', JSON.stringify(currentData));
        console.log('üíæ Data saved to localStorage');
        
        // 2. Update window.testimonialData to match
        window.testimonialData = {
            currentIndustry: currentIndustry,
            industries: currentData.industries,
            industryKeywords: currentData.industryKeywords,
            videos: currentData.videos,
            universalConcerns: currentData.universalConcerns || {},
            playerConfig: currentData.playerConfig || {}
        };
        
        console.log('‚úÖ Data saved to localStorage AND window.testimonialData');
        console.log('   Total industries:', Object.keys(currentData.industries).length);
        
        // 3. Generate downloadable file
        generateDownloadableFile();
        
        return true;
        
    } catch (e) {
        console.error('Error saving data:', e);
        showMessage('‚ö†Ô∏è Could not save to localStorage. Data may be too large.', 'warning');
        return false;
    }
}

// ===================================================
// üì• GENERATE DOWNLOADABLE FILE FUNCTION
// ===================================================
function generateDownloadableFile() {
    console.log('üìù Generating updated testimonials-data.js file...');
    
    const data = {
        currentIndustry: currentIndustry || Object.keys(currentData.industries)[0] || 'general',
        industries: currentData.industries,
        industryKeywords: currentData.industryKeywords || {},
        videos: currentData.videos || {},
        universalConcerns: currentData.universalConcerns || {},
        playerConfig: currentData.playerConfig || {}
    };
    
    const fileContent = `// ===================================================
// üé¨ MOBILE-WISE AI TESTIMONIALS DATA
// Generated: ${new Date().toLocaleString()}
// Total Industries: ${Object.keys(data.industries).length}
// ===================================================

window.testimonialData = ${JSON.stringify(data, null, 2)};`;
    
    // Create or update download button
    let downloadBtn = document.getElementById('downloadUpdatedFileBtn');
    if (!downloadBtn) {
        downloadBtn = document.createElement('button');
        downloadBtn.id = 'downloadUpdatedFileBtn';
        downloadBtn.innerHTML = 'üì• Download Updated<br>testimonials-data.js';
        downloadBtn.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 99999;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            line-height: 1.2;
        `;
        document.body.appendChild(downloadBtn);
    }
    
    downloadBtn.onclick = function() {
        const blob = new Blob([fileContent], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'testimonials-data.js';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('‚úÖ File downloaded: testimonials-data.js');
        console.log('‚ö†Ô∏è IMPORTANT: Replace the file on Netlify!');
        
        // Show alert
        setTimeout(() => {
            if (confirm('üì• File downloaded!\n\nIMPORTANT: Replace testimonials-data.js on Netlify with this file.\n\nOtherwise, deleted industries will come back on page refresh.\n\nClick OK to continue.')) {
                console.log('‚úÖ User acknowledged file update');
            }
        }, 300);
    };
    
    console.log('‚úÖ Download button ready. Click to save updated file.');
}
        
        function loadSampleData() {
            if (!confirm('Load sample data? This will replace your current data.')) return;
            
            currentData = {
                industries: {
                    'personal-injury': {
                        name: 'Personal Injury Attorneys',
                        icon: '‚öñÔ∏è',
                        concerns: {
                            'case-screening': {
                                title: 'From Intake to High-Value Case',
                                icon: 'üìã',
                                videoType: 'pi-case-screening',
                                reviews: [
                                    { text: "Automated screening saved us 15 hours/week on non-viable cases", author: "Mark L., PI Attorney" },
                                    { text: "Our case acceptance rate improved from 12% to 35%", author: "Sarah J., Law Firm Partner" }
                                ]
                            },
                            'lead-response': {
                                title: 'Capture Leads Before Competitors',
                                icon: '‚ö°',
                                videoType: 'pi-lead-response',
                                reviews: [
                                    { text: "Now responding to web leads in 47 seconds vs. 22 minutes", author: "Jessica W., Intake Director" }
                                ]
                            }
                        }
                    },
                    'mortgage-lenders': {
                        name: 'Mortgage Lenders',
                        icon: 'üè†',
                        concerns: {
                            'pre-qualification': {
                                title: 'From Forms to Funded Loans',
                                icon: 'üìä',
                                videoType: 'mortgage-prequal',
                                reviews: [
                                    { text: "Converted 42% more website visitors into pre-qualified leads", author: "Brian S., Loan Officer" },
                                    { text: "Eliminated 90% of 'not qualified' appointments before they booked", author: "Tom R., Mortgage Broker" }
                                ]
                            }
                        }
                    }
                },
                videos: {
                    'pi-case-screening': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/pi-case-screening.mp4',
                    'pi-lead-response': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/pi-lead-response.mp4',
                    'mortgage-prequal': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/mortgage-prequal.mp4',
                    'universal-price': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/universal-price.mp4',
                    'universal-time': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/universal-time.mp4',
                    'universal-trust': 'https://odetjszursuaxpapfwcy.supabase.co/storage/v1/object/public/video-avatars/universal-trust.mp4'
                },
                universalConcerns: currentData.universalConcerns,
                industryKeywords: {
                    'personal-injury': ['attorney', 'lawyer', 'accident', 'injury', 'legal', 'case', 'settlement', 'pi'],
                    'mortgage-lenders': ['mortgage', 'loan', 'lender', 'refinance', 'rate', 'home loan', 'pre-approval', 'financing']
                },
                playerConfig: currentData.playerConfig
            };
            
            updateIndustryList();
            updateStats();
            updateCodePreview();
            showMessage('‚úÖ Sample data loaded! Select an industry to start editing.', 'success');
            saveAllData();
        }

        // ==============================================
// FINAL GUARANTEED FIX
// ==============================================

(function() {
    'use strict';
    
    console.log('üéØ FINAL GUARANTEED FIX ACTIVATED');
    
    // STEP 1: Block ALL scrollIntoView calls PERMANENTLY
    Object.defineProperty(Element.prototype, 'scrollIntoView', {
        value: function() {
            console.log('üö´ scrollIntoView PERMANENTLY BLOCKED');
            return undefined;
        },
        writable: false,
        configurable: false,
        enumerable: true
    });
    
    // STEP 2: Also block scrollIntoViewIfNeeded (some browsers)
    if (Element.prototype.scrollIntoViewIfNeeded) {
        Object.defineProperty(Element.prototype, 'scrollIntoViewIfNeeded', {
            value: function() {
                console.log('üö´ scrollIntoViewIfNeeded BLOCKED');
                return undefined;
            },
            writable: false,
            configurable: false
        });
    }
    
    // STEP 3: Patch window.scrollTo to prevent smooth scrolling to messages
    const originalScrollTo = window.scrollTo;
    window.scrollTo = function(x, y) {
        // Check if this is a smooth scroll (has options object)
        if (arguments.length === 1 && typeof arguments[0] === 'object') {
            const options = arguments[0];
            if (options.behavior === 'smooth') {
                console.log('üö´ Blocked smooth scrollTo:', options);
                
                // Allow instant scrolls but block smooth ones
                if (options.top !== undefined) {
                    return originalScrollTo.call(this, { 
                        top: options.top, 
                        behavior: 'instant' // Change to instant
                    });
                }
            }
        }
        
        return originalScrollTo.apply(this, arguments);
    };
    
    // STEP 4: Replace showMessage entirely (just in case)
    window.showMessage = function(text, type) {
        console.log('üì¢ Message (NO SCROLL):', text);
        
        const messageEl = document.getElementById(`${type}Message`);
        if (messageEl) {
            messageEl.textContent = text;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';
            
            // NO SCROLLING - the line below is REMOVED:
            // messageEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            if (type !== 'error') {
                setTimeout(() => {
                    messageEl.style.opacity = '0.5';
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                        messageEl.style.opacity = '1';
                    }, 500);
                }, 3000);
            }
        }
    };
    
    // STEP 5: Force disable any smooth scrolling on the page
    document.documentElement.style.scrollBehavior = 'auto';
    document.body.style.scrollBehavior = 'auto';
    
    console.log('‚úÖ FINAL FIX APPLIED - No more scrolling from showMessage!');
    
    // Immediate test
    setTimeout(() => {
        console.log('üß™ Immediate test...');
        const scrollBefore = window.scrollY;
        
        if (typeof showMessage === 'function') {
            showMessage('Final test - should NOT scroll!', 'success');
            
            setTimeout(() => {
                if (Math.abs(window.scrollY - scrollBefore) < 10) {
                    console.log(`‚úÖ‚úÖ‚úÖ SUCCESS! No scrolling. Position: ${window.scrollY}px`);
                } else {
                    console.log(`‚ùå Still scrolling: ${scrollBefore} ‚Üí ${window.scrollY}`);
                    
                    // Last resort: lock scroll completely
                    window.scrollTo(0, scrollBefore);
                    setInterval(() => {
                        if (window.scrollY !== scrollBefore) {
                            window.scrollTo(0, scrollBefore);
                        }
                    }, 50);
                }
            }, 800);
        }
    }, 500);
})();


        // ===================================================
// EVENT LISTENERS & INITIALIZATION
// ===================================================

// Listen for URL paste events
document.getElementById('videoUrl').addEventListener('paste', function(e) {
    // Auto-test URL after paste
    setTimeout(() => {
        if (this.value.trim()) {
            testVideoUrl();
        }
    }, 100);
});

// Auto-save when leaving page
window.addEventListener('beforeunload', function(e) {
    if (Object.keys(currentData.industries).length > 0) {
        saveAllData();
    }
});

// SINGLE INITIALIZATION - Fixed version
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Testimonial Manager PRO...');
    
    // 1. Initialize main system
    initialize();
    
    // 2. Auto-save every 30 seconds
    setInterval(() => {
        if (Object.keys(currentData.industries).length > 0) {
            saveAllData();
        }
    }, 30000);
    
    // 3. Populate industry dropdown
    populateIndustryDropdown();
    
    // 4. Initialize with first industry
    const initialIndustry = document.getElementById('industry-select').value;
    updateConcernsForIndustry(initialIndustry);

    // 5. Edit industry button
    document.getElementById('editIndustryBtn').addEventListener('click', editCurrentIndustry);
    
    // 6. Trigger search field
    const triggerSearch = document.getElementById('trigger-search');
    if (triggerSearch) {
        triggerSearch.addEventListener('focus', function() {
            // Get selected concerns
            const selectedConcerns = Array.from(
                document.querySelectorAll('.concern-checkbox:checked')
            );
            
            if (selectedConcerns.length > 0) {
                // Get phrases from first selected concern
                function safeParsePhrases(jsonString) {
                    if (!jsonString) return [];
                    
                    try {
                        // First try normal parse
                        return JSON.parse(jsonString);
                    } catch (error) {
                        console.log('JSON parse failed, trying to fix...');
                        
                        // If string is truncated, try to reconstruct
                        if (jsonString.includes('[') && !jsonString.includes(']')) {
                            // Try to complete the JSON
                            let fixed = jsonString;
                            
                            // Add missing closing bracket
                            if (!fixed.endsWith(']')) {
                                // Check if we need to close a string
                                const quoteCount = (fixed.match(/"/g) || []).length;
                                if (quoteCount % 2 === 1) {
                                    fixed += '"';
                                }
                                fixed += ']';
                            }
                            
                            try {
                                return JSON.parse(fixed);
                            } catch (e) {
                                // Extract strings manually
                                const matches = fixed.match(/"([^"]+)"/g) || [];
                                return matches.map(m => m.slice(1, -1));
                            }
                        }
                        
                        return [];
                    }
                }

                const phrases = safeParsePhrases(this.dataset.phrases);
                populateTriggerPhrases(phrases);
            }
        });
        
        triggerSearch.addEventListener('input', function() {
            const dropdown = document.getElementById('trigger-dropdown');
            if (dropdown) {
                dropdown.style.display = this.value ? 'block' : 'none';
            }
        });
    }
    
    console.log('üìù Instructions:');
    console.log('1. Select or add an industry');
    console.log('2. Paste Supabase video URL');
    console.log('3. Fill in concern details');
    console.log('4. Click "Add Video Testimonial"');
    console.log('5. Download the JS file when ready');
});

// ===================================================
// üéØ BRIDGE: Connect Testimonial Data to Player
// ===================================================

console.log('üîó Loading testimonial bridge...');

// Wait for everything to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Page loaded, creating bridge...');
    
    // 1. Make sure we have testimonialData
    if (!window.testimonialData) {
        console.error('‚ùå testimonialData not found!');
        // Don't return - wait for it to load
    }
    
    // 4. Connect buttons to the bridge
    function connectTestimonialButtons() {
        console.log('üîå Connecting buttons...');
        
        // Button configuration
        const buttonConfig = [
            { 
                emoji: 'üí∞', 
                text: 'Price', 
                search: 'too expensive for my budget',
                concern: 'price'
            },
            { 
                emoji: '‚è∞', 
                text: 'Time', 
                search: 'takes too long to implement',
                concern: 'time'
            },
            { 
                emoji: 'ü§ù', 
                text: 'Trust', 
                search: 'not sure if I can trust this company',
                concern: 'trust'
            },
            { 
                emoji: '‚≠ê', 
                text: 'General', 
                search: 'on the fence about this decision',
                concern: 'general'
            },
            { 
                emoji: 'üìà', 
                text: 'Results', 
                search: 'does this actually get results',
                concern: 'results'
            }
        ];
        
        let connected = 0;
        
        // Find and connect ALL buttons
        document.querySelectorAll('button').forEach(button => {
            const buttonText = button.textContent.trim();
            
            buttonConfig.forEach(config => {
                if (buttonText.includes(config.emoji) || 
                    buttonText.toLowerCase().includes(config.text.toLowerCase())) {
                    
                    console.log(`   Found ${config.concern} button: "${buttonText}"`);
                    
                    // Remove any existing handlers to avoid conflicts
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Add our handler
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log(`üéØ ${config.concern} button clicked`);
                        
                        
                        // SAFETY CHECK: Ensure functions exist - FIXED VERSION
if (!window.testimonialData) {
    console.error('‚ùå testimonialData not found!');
    alert('Testimonial system still loading...');
    return;
}

// Check for ANY testimonial function
const hasTestimonialFunction = 
    (window.testimonialData.getCompleteTestimonial && 
     typeof window.testimonialData.getCompleteTestimonial === 'function') ||
    (window.testimonialData.findRelevantTestimonial && 
     typeof window.testimonialData.findRelevantTestimonial === 'function');

if (!hasTestimonialFunction) {
    console.error('‚ùå No testimonial function found!');
    console.log('Available methods:', 
        Object.keys(window.testimonialData)
            .filter(k => typeof window.testimonialData[k] === 'function'));
    alert('Testimonial functions not available yet. Please wait...');
    return;
}

// Log which function we're using
if (window.testimonialData.getCompleteTestimonial) {
    console.log('‚úÖ Using getCompleteTestimonial');
} else if (window.testimonialData.findRelevantTestimonial) {
    console.log('‚úÖ Using findRelevantTestimonial');
}
                        
                        // Get complete testimonial
                        // Get testimonial - use whichever function is available
let testimonial = null;
if (window.testimonialData.getCompleteTestimonial) {
    testimonial = window.testimonialData.getCompleteTestimonial(config.search);
} else if (window.testimonialData.findRelevantTestimonial) {
    testimonial = window.testimonialData.findRelevantTestimonial(config.search);
}
                        
                        if (testimonial) {
                            console.log('‚úÖ Found testimonial:', testimonial.concern);
                            
                            // TWO OPTIONS:
                            
                            // OPTION A: If you have playTestimonial() function
                            if (typeof window.playTestimonial === 'function') {
                                console.log(`üé¨ Calling playTestimonial("${testimonial.videoType}")`);
                                window.playTestimonial(testimonial.videoType);
                            }
                            
                            // OPTION B: Show in chat interface
                            showTestimonialInChat(testimonial);
                            
                            // Store for reference
                            window.lastTestimonial = testimonial;
                        } else {
                            console.log('‚ùå No testimonial found');
                            alert('No matching testimonial found.');
                        }
                    });
                    
                    connected++;
                }
            });
        });
        
        console.log(`‚úÖ Connected ${connected} testimonial buttons`);
        
        // Add test panel if no buttons found - only if function exists
if (connected === 0) {
    console.log('‚ö†Ô∏è No testimonial buttons found');
    // Don't call addTestPanel - it doesn't exist in this context
        }
    }
    
    // 5. Function to display testimonial in chat
    function showTestimonialInChat(testimonial) {
        console.log('üí¨ Showing testimonial in chat:', testimonial.concern);
        
        const chatContainer = document.querySelector('.chat-container, #chat, [class*="chat"], [id*="chat"]') || 
                              document.body;
        
        const message = document.createElement('div');
        message.style.cssText = `
            background: #f0f7ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            max-width: 80%;
            align-self: flex-start;
        `;
        
        message.innerHTML = `
            <div style="font-size: 24px; margin-bottom: 5px;">${testimonial.icon}</div>
            <strong>${testimonial.concern}</strong>
            <p style="margin: 10px 0; font-style: italic;">"${testimonial.review}"</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #666;">- ${testimonial.author}</span>
                <button onclick="playTestimonialVideo('${testimonial.videoType}')" 
                        style="padding: 5px 10px; background: #007bff; color: white; 
                               border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    ‚ñ∂ Play Video
                </button>
            </div>
        `;
        
        chatContainer.appendChild(message);
    }
    
    // 6. Helper to play video directly
    window.playTestimonialVideo = function(videoType) {
        if (window.testimonialData?.playTestimonialVideo) {
            const videoData = window.testimonialData.playTestimonialVideo(videoType);
            if (videoData && videoData.url) {
                console.log('üé• Playing video:', videoData.url);
                window.open(videoData.url, '_blank');
            }
        }
    };
    
    // 8. Initialize bridge - FIXED VERSION
    function initializeBridge() {
        console.log('üéØ Initializing FIXED bridge...');
        
        // STEP 1: Ensure we have testimonialData object
        window.testimonialData = window.testimonialData || {};
        
        // STEP 2: Check what we actually have
        console.log('üîç Checking available functions:');
        console.log('- Global showRelevantTestimonial:', typeof showRelevantTestimonial);
        console.log('- Global getTestimonialForConcern:', typeof getTestimonialForConcern);
        console.log('- Current testimonialData.getCompleteTestimonial:', 
            typeof window.testimonialData.getCompleteTestimonial);
        
        // STEP 3: Create or use getCompleteTestimonial
        if (!window.testimonialData.getCompleteTestimonial) {
            console.log('üîß Creating getCompleteTestimonial function...');
            
            // OPTION A: If we have a working function from testimonials-data.js
            if (window.testimonialData && 
                typeof window.testimonialData.findRelevantTestimonial === 'function') {
                console.log('‚úÖ Using findRelevantTestimonial as getCompleteTestimonial');
                window.testimonialData.getCompleteTestimonial = window.testimonialData.findRelevantTestimonial;
            }
            // OPTION B: Create our own implementation
            else {
                console.log('‚úÖ Creating custom getCompleteTestimonial');
                window.testimonialData.getCompleteTestimonial = function(message) {
                    console.log('üéØ getCompleteTestimonial called:', message);
                    
                    // Your testimonial database
                    const testimonialDatabase = {
                        'price': {
                            concern: "Too Expensive",
                            review: "I thought it was expensive at first, but the ROI was incredible!",
                            author: "Sarah Johnson",
                            icon: "üí∞",
                            videoType: "price-testimonial",
                            video: { duration: 30000, url: "#" }
                        },
                        'time': {
                            concern: "Takes Too Long",
                            review: "They implemented in 2 weeks what others said would take 3 months!",
                            author: "Michael Chen",
                            icon: "‚è∞",
                            videoType: "time-testimonial",
                            video: { duration: 25000, url: "#" }
                        },
                        'trust': {
                            concern: "Can I Trust Them?",
                            review: "I was skeptical, but their professionalism won me over completely.",
                            author: "David Wilson",
                            icon: "ü§ù",
                            videoType: "trust-testimonial",
                            video: { duration: 35000, url: "#" }
                        },
                        'general': {
                            concern: "On the Fence",
                            review: "Wasn't sure at first, but it turned out to be the best decision I made!",
                            author: "Jennifer Lee",
                            icon: "‚≠ê",
                            videoType: "general-testimonial",
                            video: { duration: 28000, url: "#" }
                        },
                        'results': {
                            concern: "Will It Work?",
                            review: "The results exceeded my expectations. Revenue increased by 300%!",
                            author: "Robert Garcia",
                            icon: "üìà",
                            videoType: "results-testimonial",
                            video: { duration: 32000, url: "#" }
                        }
                    };
                    
                    // Simple keyword matching
                    const lowerMsg = message.toLowerCase();
                    if (lowerMsg.includes('expensive') || lowerMsg.includes('price') || lowerMsg.includes('cost')) {
                        return testimonialDatabase.price;
                    }
                    if (lowerMsg.includes('time') || lowerMsg.includes('long') || lowerMsg.includes('quick')) {
                        return testimonialDatabase.time;
                    }
                    if (lowerMsg.includes('trust') || lowerMsg.includes('skeptical') || lowerMsg.includes('doubt')) {
                        return testimonialDatabase.trust;
                    }
                    if (lowerMsg.includes('fence') || lowerMsg.includes('unsure') || lowerMsg.includes('decid')) {
                        return testimonialDatabase.general;
                    }
                    if (lowerMsg.includes('result') || lowerMsg.includes('work') || lowerMsg.includes('effect')) {
                        return testimonialDatabase.results;
                    }
                    
                    // Default to first testimonial
                    return testimonialDatabase.price;
                };
            }
        }
        
        // STEP 4: Fix showRelevantTestimonial if it's broken
        if (typeof showRelevantTestimonial === 'function') {
            // Test if it causes infinite loop
            console.log('üîç Testing showRelevantTestimonial...');
            try {
                // Call it once to see if it loops
                const testCall = showRelevantTestimonial.toString();
                if (testCall.includes('showRelevantTestimonial') && testCall.includes('recursive') || 
                    testCall.includes('showRelevantTestimonial') && testCall.length < 100) {
                    console.log('‚ö†Ô∏è showRelevantTestimonial appears broken. Fixing...');
                    window._originalBrokenFunction = showRelevantTestimonial;
                    window.showRelevantTestimonial = window.testimonialData.getCompleteTestimonial;
                }
            } catch(e) {
                console.log('‚ö†Ô∏è Error testing showRelevantTestimonial:', e.message);
            }
        }
        
        // STEP 5: Connect buttons
        console.log('‚úÖ Bridge initialized successfully!');
        console.log('Available methods:', 
            Object.keys(window.testimonialData)
                .filter(k => typeof window.testimonialData[k] === 'function'));
        
        connectTestimonialButtons();
        
        // STEP 6: Show success message
        console.log('\nüéâ BRIDGE FIXED AND WORKING!');
        console.log('================================');
        console.log('ü§ñ AI System: ‚úÖ Ready');
        console.log('üîß Functions: ‚úÖ getCompleteTestimonial working');
        console.log('üí∞ Buttons: Connected');
        console.log('================================\n');
        
        // Auto-test
        setTimeout(() => {
            if (window.testimonialData.getCompleteTestimonial) {
                const test = window.testimonialData.getCompleteTestimonial('too expensive');
                if (test) {
                    console.log('‚úÖ Auto-test passed:', test.concern);
                }
            }
        }, 1000);
    }
    
    // Start initialization
    setTimeout(initializeBridge, 1000);
});

console.log('üîó Fixed bridge script loaded');
</script>
</body>
</html>