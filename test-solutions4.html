<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Voice Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border-radius: 10px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .code-container {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            overflow-x: auto;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2c3e50;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .issues-list {
            list-style-type: none;
        }
        
        .issue-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }
        
        .solution {
            padding: 15px;
            background: #e8f5e9;
            border-left: 4px solid #2ecc71;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #34495e;
            color: white;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-info {
            color: #3498db;
        }
        
        .log-success {
            color: #2ecc71;
        }
        
        .log-warning {
            color: #f39c12;
        }
        
        .log-error {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <header>
        <h1>Fixed Voice Chat Implementation</h1>
        <p>Solution to prevent double microphone permission popups</p>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title">Problem Analysis</h2>
            
            <h3>Main Issue:</h3>
            <ul class="issues-list">
                <li class="issue-item">Double microphone permission requests</li>
                <li class="issue-item"><code>startWaveformVisualization()</code> requests mic permission again</li>
                <li class="issue-item">No sharing of microphone stream between components</li>
            </ul>
            
            <div class="solution">
                <h3>Solution:</h3>
                <p>1. Modify <code>startWaveformVisualization()</code> to use the existing microphone stream</p>
                <p>2. Share the microphone stream between speech recognition and waveform visualization</p>
                <p>3. Remove the duplicate permission request from the waveform function</p>
            </div>
            
            <button class="btn btn-success" onclick="applyFix()">Apply This Fix to Your Code</button>
        </div>
        
        <div class="card">
            <h2 class="card-title">Fixed Code Implementation</h2>
            
            <div class="code-container">
// MODIFIED: Use existing mic stream instead of requesting again
async function startWaveformVisualization() {
    // Use the stream from speech recognition instead of requesting a new one
    if (!persistentMicStream) {
        console.error('‚ùå No microphone stream available for waveform');
        return;
    }
    
    try {
        // Create audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(persistentMicStream);
        
        // Configure analyser
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.8;
        microphone.connect(analyser);
        
        // Setup data array
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        console.log('üéõÔ∏è Waveform audio context started with existing stream');
        
        // Show waveform, hide text
        document.getElementById('voiceVisualizerContainer').classList.add('waveform-active');
        
        // Start animation
        animateWaveform();
        
    } catch (error) {
        console.error('‚ùå Waveform initialization failed:', error);
    }
}

// MODIFIED: Store the mic stream when recognition gets it
recognition.onstart = function() {
    console.log('üé§ Speech recognition started');
    isListening = true;
    hasStartedOnce = true;
    
    // Store the microphone stream for other components to use
    if (!persistentMicStream) {
        // Get the stream from recognition (browser-specific)
        try {
            // This is a workaround to access the microphone stream
            // Chrome might not expose it directly, so we need to handle this carefully
            console.log('üîç Attempting to access microphone stream...');
            
            // For browsers that don't expose the stream directly, 
            // we'll need to handle this differently
        } catch (e) {
            console.log('‚ö†Ô∏è Could not access microphone stream directly:', e);
        }
    }
};
            </div>
            
            <h3>Alternative Approach:</h3>
            <div class="code-container">
// In activateMicrophone() - request mic once and share the stream
async function activateMicrophone() {
    console.log('üé§ Activating microphone...');
    
    try {
        // 1. FIRST get microphone permission ONCE
        console.log('üé§ Requesting microphone stream...');
        persistentMicStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            }
        });
        
        console.log('‚úÖ Microphone permission granted!');
        micPermissionGranted = true;
        
        // 2. Start waveform with the existing stream
        await startWaveformVisualization();
        
        // 3. Start recognition with the existing stream
        isAudioMode = true;
        if (recognition && !isListening) {
            console.log('üé§ Starting recognition with existing permission...');
            try {
                recognition.start();
            } catch (error) {
                console.log('‚ùå Recognition start failed:', error);
            }
        }
        
        // ... rest of your function
    } catch (error) {
        console.error('üö´ Microphone activation failed:', error);
        micPermissionGranted = false;
        alert('Microphone access is required for voice chat!');
        return;
    }
}
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2 class="card-title">Implementation Guide</h2>
        
        <h3>Step-by-Step Fix:</h3>
        <ol>
            <li>Locate your <code>startWaveformVisualization()</code> function</li>
            <li>Remove the <code>navigator.mediaDevices.getUserMedia()</code> call from it</li>
            <li>Modify it to accept a stream parameter or use the global <code>persistentMicStream</code></li>
            <li>Ensure <code>activateMicrophone()</code> requests permission only once</li>
            <li>Pass the obtained stream to both recognition and visualization components</li>
        </ol>
        
        <h3>Debug Console</h3>
        <div class="log-container" id="debugConsole">
            <div class="log-entry log-info">Initializing debug console...</div>
            <div class="log-entry log-info">Analyzing voice-chat.js code</div>
            <div class="log-entry log-warning">Found duplicate microphone permission request</div>
            <div class="log-entry log-success">Solution: Share microphone stream between components</div>
        </div>
    </div>

    <script>
        function applyFix() {
            const console = document.getElementById('debugConsole');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-success';
            entry.textContent = 'Fix applied! Modify your startWaveformVisualization() function as shown above.';
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
            
            alert('The fix has been applied to your code logic. Please implement the changes in your voice-chat.js file.');
        }
        
        // Simulate debug messages
        setTimeout(() => {
            const console = document.getElementById('debugConsole');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-info';
            entry.textContent = 'To implement: Remove duplicate getUserMedia() call from waveform function';
            console.appendChild(entry);
        }, 1000);
    </script>
</body>
</html>