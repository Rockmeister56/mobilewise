<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceChat Direct</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .permission-panel {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .permission-panel h2 {
            margin-bottom: 20px;
            color: #ff7e5f;
        }
        
        .btn {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .chat-interface {
            display: none;
            margin-top: 20px;
            width: 100%;
        }
        
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 20px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-message {
            background: rgba(255, 255, 255, 0.2);
            border-top-left-radius: 5px;
            align-self: flex-start;
        }
        
        .user-message {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            border-top-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .input-area {
            display: flex;
            margin-top: 20px;
        }
        
        input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 50px 0 0 50px;
            font-size: 1rem;
        }
        
        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            color: white;
            border: none;
            border-radius: 0 50px 50px 0;
            cursor: pointer;
        }
        
        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .mic-btn.listening {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            margin: 10px 0;
            text-align: center;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #F44336;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px;
            margin: 10px 0;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-top-left-radius: 5px;
            align-self: flex-start;
            max-width: 80%;
        }
        
        .typing-dots {
            display: flex;
            align-items: center;
            height: 20px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: white;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite both;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0% { transform: scale(0); }
            50% { transform: scale(1); }
            100% { transform: scale(0); }
        }
        
        .speech-preview {
            display: none;
            padding: 12px;
            margin: 10px 0;
            border-radius: 20px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            border-top-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
            max-width: 80%;
            opacity: 0.7;
            animation: grow 0.2s ease;
        }
        
        @keyframes grow {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 0.7; }
        }
        
        .text-input-fallback {
            display: none;
            margin-top: 20px;
            width: 100%;
        }
        
        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .quick-btn {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .quick-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .smart-button {
            display: none;
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        .voice-visualizer {
            display: none;
            height: 40px;
            margin: 15px 0;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .visualizer-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            padding: 0 10px;
        }
        
        .visualizer-bar {
            width: 6px;
            background: linear-gradient(to top, #4CAF50, #8BC34A);
            border-radius: 3px;
            transition: height 0.1s ease;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 1rem;
            }
            
            .mic-btn {
                width: 70px;
                height: 70px;
                font-size: 1.7rem;
            }
            
            .chat-messages {
                height: 250px;
            }
            
            .quick-questions {
                flex-direction: column;
            }
            
            .quick-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>VoiceChat Direct</h1>
            <p>No splash screens, no intermediaries - just voice chat</p>
        </header>
        
        <div class="permission-panel" id="permissionPanel">
            <h2>Enable Microphone Access</h2>
            <p>To use voice features, we need access to your microphone</p>
            <p>Click the button below to enable microphone access</p>
            <button class="btn" id="enableMic">Enable Microphone</button>
            
            <div class="status-indicator" id="statusIndicator" style="display: none;">
                Checking microphone access...
            </div>
        </div>
        
        <div class="chat-interface" id="chatInterface">
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">Hello! I'm your AI assistant. Enable microphone access to talk with me.</div>
            </div>
            
            <div class="speech-preview" id="speechPreview"></div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="voice-visualizer" id="voiceVisualizer">
                <div class="visualizer-bars" id="visualizerBars">
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                </div>
            </div>
            
            <div class="quick-questions">
                <button class="quick-btn" onclick="askQuickQuestion('How much is my practice worth?')">Practice Valuation</button>
                <button class="quick-btn" onclick="askQuickQuestion('I want to sell my practice')">Selling Options</button>
                <button class="quick-btn" onclick="askQuickQuestion('I want to buy a practice')">Buying Options</button>
                <button class="quick-btn" onclick="askQuickQuestion('Connect me with Bruce')">Contact Bruce</button>
            </div>
            
            <div class="smart-button" id="smartButton"></div>
            
            <div class="voice-controls" id="voiceControls">
                <div class="mic-btn" id="micButton">
                    <i>üé§</i>
                </div>
                <p id="micStatus">Tap the microphone to start speaking</p>
            </div>
            
            <div class="text-input-fallback" id="textInputFallback">
                <div class="input-area">
                    <input type="text" id="userInput" placeholder="Type your message here...">
                    <button class="send-btn" id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================================
        // üèóÔ∏è GLOBAL VARIABLES
        // ===================================================
        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        let isAudioMode = false;
        let currentAudio = null;
        let persistentMicStream = null;
        let micPermissionGranted = false;
        let conversationState = 'initial';
        let lastAIResponse = '';
        let userResponseCount = 0;
        let shouldShowSmartButton = false;
        let smartButtonText = 'AI Smart Button';
        let smartButtonAction = 'default';
        let visualizerInterval = null;

        // ===================================================
        // üì± MOBILE DEVICE DETECTION
        // ===================================================
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // ===================================================
        // üé§ MICROPHONE PERMISSION & INITIALIZATION
        // ===================================================
        async function requestMicrophoneWithFallback() {
            try {
                // First try the standard way
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                return stream;
            } catch (error) {
                console.log('Standard permission failed, trying fallback...');
                
                // Create a temporary audio element to trigger permission differently
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRnoAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoAAAC';
                audio.volume = 0;
                
                return new Promise((resolve, reject) => {
                    audio.oncanplay = async () => {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            resolve(stream);
                        } catch (error2) {
                            reject(error2);
                        }
                    };
                    
                    audio.onerror = () => reject(error);
                    audio.play().catch(reject);
                });
            }
        }

        async function requestMicrophoneAccess() {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.style.display = 'block';
            statusIndicator.textContent = "Requesting microphone access...";
            statusIndicator.className = 'status-indicator';
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusIndicator.textContent = "Error: getUserMedia is not supported in this browser";
                statusIndicator.classList.add('error');
                return false;
            }
            
            try {
                const stream = await requestMicrophoneWithFallback();
                statusIndicator.textContent = "Microphone access granted!";
                statusIndicator.classList.add('success');
                
                // Success - show chat interface
                setTimeout(() => {
                    document.getElementById('permissionPanel').style.display = 'none';
                    document.getElementById('chatInterface').style.display = 'block';
                    
                    // Stop all tracks when done (for cleanup)
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    
                    addAIMessage("Microphone access granted! You can now use voice features.");
                    
                    // Initialize speech recognition
                    initializeSpeechRecognition();
                    
                    // For mobile, we need to wait for user interaction to start listening
                    if (isMobileDevice()) {
                        addAIMessage("Tap the microphone button to start speaking.");
                    } else {
                        startListening();
                    }
                }, 1000);
                
                return true;
            } catch (err) {
                console.error("Microphone access denied:", err);
                statusIndicator.textContent = "Microphone access denied. Please check your browser permissions.";
                statusIndicator.classList.add('error');
                
                // Still show chat interface but with text only
                setTimeout(() => {
                    document.getElementById('permissionPanel').style.display = 'none';
                    document.getElementById('chatInterface').style.display = 'block';
                    document.getElementById('voiceControls').style.display = 'none';
                    document.getElementById('textInputFallback').style.display = 'block';
                    
                    addAIMessage("Microphone access was denied. Please use the text input to chat with me.");
                }, 1500);
                
                return false;
            }
        }

        // ===================================================
        // üé§ SPEECH RECOGNITION SYSTEM
        // ===================================================
        function checkSpeechSupport() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('‚ùå Speech recognition not supported in this browser');
                addAIMessage("Your browser doesn't support speech recognition. Please use Chrome or Edge.");
                return false;
            }
            return true;
        }

        function initializeSpeechRecognition() {
            if (!checkSpeechSupport()) return false;

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            console.log('‚úÖ Speech recognition initialized');
            return true;
        }

        function startListening() {
            console.log('üéØ startListening() called');
            if (!checkSpeechSupport()) return;
            if (isSpeaking) return;

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';
                }

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        
                        if (result.isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // Show interim results in the preview area
                    const speechPreview = document.getElementById('speechPreview');
                    if (speechPreview && interimTranscript) {
                        speechPreview.textContent = interimTranscript;
                        speechPreview.style.display = 'block';
                    }

                    // Update input field with interim results
                    const userInput = document.getElementById('userInput');
                    if (userInput && interimTranscript) {
                        userInput.value = interimTranscript;
                    }

                    // If we have a final result, send it
                    if (finalTranscript) {
                        if (speechPreview) {
                            speechPreview.style.display = 'none';
                        }
                        if (userInput) userInput.value = finalTranscript;
                        sendMessage();
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopListening();
                    
                    // Special handling for mobile devices
                    if (isMobileDevice() && event.error === 'not-allowed') {
                        addAIMessage("Please check your browser settings to allow microphone access.");
                    } else {
                        addAIMessage("Sorry, there was an error with speech recognition: " + event.error);
                    }
                };

                recognition.onend = function() {
                    console.log('Recognition ended');
                    const micButton = document.getElementById('micButton');
                    const micStatus = document.getElementById('micStatus');
                    
                    if (micButton) micButton.classList.remove('listening');
                    if (micStatus) micStatus.textContent = "Tap the microphone to start speaking";
                    
                    const speechPreview = document.getElementById('speechPreview');
                    if (speechPreview) speechPreview.style.display = 'none';
                    
                    if (isListening && isAudioMode) {
                        setTimeout(() => {
                            if (isAudioMode && !isListening) {
                                startListening();
                            }
                        }, 100);
                    }
                };

                console.log('üé§ Starting speech recognition...');
                recognition.start();
                isListening = true;
                
                const micButton = document.getElementById('micButton');
                const micStatus = document.getElementById('micStatus');
                
                if (micButton) micButton.classList.add('listening');
                if (micStatus) micStatus.textContent = "Listening... Speak now";
                
                console.log('‚úÖ Speech recognition started successfully');

            } catch (error) {
                console.error('Error starting speech recognition:', error);
                addAIMessage("Speech recognition failed. Switching to text mode.");
                switchToTextMode();
            }
        }

        function stopListening() {
            if (recognition) {
                recognition.stop();
                recognition.onresult = null;
                recognition.onerror = null;
                recognition.onend = null;
                recognition = null;
            }

            // Update UI
            const micButton = document.getElementById('micButton');
            const micStatus = document.getElementById('micStatus');
            
            if (micButton) micButton.classList.remove('listening');
            if (micStatus) micStatus.textContent = "Tap the microphone to start speaking";

            isListening = false;
        }

        // ===================================================
        // üí¨ MESSAGE HANDLING SYSTEM
        // ===================================================
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-message';
            messageElement.textContent = message;
            
            chatMessages.appendChild(messageElement);
            scrollChatToBottom();
        }

        function addAIMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message ai-message';
            messageElement.textContent = message;
            
            chatMessages.appendChild(messageElement);
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // ===================================================
        // üó£Ô∏è VOICE SYNTHESIS SYSTEM
        // ===================================================
        function speakResponse(message) {
            if (!window.speechSynthesis) {
                console.log('‚ùå Speech synthesis not supported');
                return;
            }

            // Stop any current speech
            window.speechSynthesis.cancel();
            
            // Add slight delay for mobile to prevent clipping
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(message);
                
                // Slower rate for mobile
                utterance.rate = isMobileDevice() ? 0.9 : 1.0;
                utterance.pitch = 1.0;
                utterance.volume = isMobileDevice() ? 0.95 : 0.9;
                
                utterance.onstart = function() {
                    isSpeaking = true;
                    console.log('‚úÖ AI started speaking');
                };
                
                utterance.onend = function() {
                    isSpeaking = false;
                    console.log('‚úÖ AI finished speaking');
                    
                    // Start listening after speaking ends
                    if (isAudioMode && !isListening) {
                        setTimeout(() => {
                            startListening();
                        }, 800);
                    }
                };
                
                utterance.onerror = function(event) {
                    console.log('‚ùå Speech error:', event.error);
                    isSpeaking = false;
                };
                
                window.speechSynthesis.speak(utterance);
                currentAudio = utterance;
            }, isMobileDevice() ? 300 : 0);
        }

        function stopCurrentAudio() {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            currentAudio = null;
            isSpeaking = false;
        }

        // ===================================================
        // üìù TEXT INPUT SYSTEM
        // ===================================================
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            if (!userInput) return;
            
            const message = userInput.value.trim();
            if (!message) return;
            
            addUserMessage(message);
            userInput.value = '';
            
            // Process the message
            processUserResponse(message);
        }

        function processUserResponse(userText) {
            userResponseCount++;
            
            // Stop listening while AI responds
            stopListening();
            
            // Show typing indicator
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) typingIndicator.style.display = 'block';
            
            // Add AI response
            setTimeout(() => {
                if (typingIndicator) typingIndicator.style.display = 'none';
                
                const responseText = getAIResponse(userText);
                lastAIResponse = responseText;
                
                addAIMessage(responseText);
                speakResponse(responseText);
                
                // Update smart button
                updateSmartButton(shouldShowSmartButton, smartButtonText, smartButtonAction);
            }, 800);
        }

        // ===================================================
        // üß† AI RESPONSE SYSTEM
        // ===================================================
        function getAIResponse(userInput) {
            const userText = userInput.toLowerCase();
            let responseText = '';
            
            if (conversationState === 'initial') {
                if (userText.includes('sell') || userText.includes('practice') || userText.includes('selling')) {
                    responseText = "EXCELLENT timing for selling your accounting practice! The market is very strong right now. Should Bruce call you today or tomorrow for your FREE practice valuation?";
                    conversationState = 'selling_inquiry';
                    shouldShowSmartButton = true;
                    smartButtonText = 'Schedule Free Valuation';
                    smartButtonAction = 'valuation';
                } else if (userText.includes('buy') || userText.includes('purchase') || userText.includes('buying') || userText.includes('acquire')) {
                    responseText = "Looking to BUY a CPA firm? Perfect! Bruce has exclusive off-market opportunities available RIGHT NOW. Should Bruce show you available practices today or tomorrow?";
                    conversationState = 'buying_inquiry';
                    shouldShowSmartButton = true;
                    smartButtonText = 'View Available Practices';
                    smartButtonAction = 'buying';
                } else if (userText.includes('value') || userText.includes('worth') || userText.includes('valuation') || userText.includes('evaluate')) {
                    responseText = "Your accounting practice could be worth MORE than you think! Bruce offers a FREE consultation to evaluate your practice. Are you interested in a valuation today?";
                    conversationState = 'valuation_inquiry';
                    shouldShowSmartButton = true;
                    smartButtonText = 'Get Practice Valuation';
                    smartButtonAction = 'valuation';
                } else {
                    responseText = "I specialize in CPA firm transactions - buying, selling, and valuations. What specifically are you interested in learning more about?";
                }
            } else if (conversationState === 'selling_inquiry') {
                if (userText.includes('today') || userText.includes('now') || userText.includes('asap')) {
                    responseText = "Great! Bruce will call you today. What's the best phone number to reach you, and what time works best?";
                    conversationState = 'contact_today';
                    shouldShowSmartButton = true;
                    smartButtonText = 'Schedule Today';
                    smartButtonAction = 'schedule_today';
                } else if (userText.includes('tomorrow')) {
                    responseText = "Perfect! Bruce will call you tomorrow. What's the best phone number to reach you, and what time works best?";
                    conversationState = 'contact_tomorrow';
                    shouldShowSmartButton = true;
                    smartButtonText = 'Schedule Tomorrow';
                    smartButtonAction = 'schedule_tomorrow';
                } else if (userText.includes('yes') || userText.includes('sure') || userText.includes('okay')) {
                    responseText = "Excellent! Should Bruce call you today or tomorrow for your FREE practice valuation?";
                    conversationState = 'selling_inquiry';
                } else {
                    responseText = "I didn't quite catch that. Should Bruce call you today or tomorrow for your FREE practice valuation?";
                }
            } else {
                responseText = "Thanks for your message. Is there anything else I can help you with regarding your CPA practice?";
                conversationState = 'initial';
            }

            return responseText;
        }

        // ===================================================
        // üì± TEXT MODE SWITCHER
        // ===================================================
        function switchToTextMode() {
            console.log('üîÑ Switching to text mode');
            
            // Stop any ongoing audio
            stopCurrentAudio();
            
            // Stop listening if active
            stopListening();
            
            // Close microphone stream if open
            if (persistentMicStream) {
                persistentMicStream.getTracks().forEach(track => track.stop());
                persistentMicStream = null;
            }
            
            // Update mode flag
            isAudioMode = false;
            micPermissionGranted = false;
            
            // Update UI
            const micButton = document.getElementById('micButton');
            const voiceVisualizer = document.getElementById('voiceVisualizer');
            const voiceControls = document.getElementById('voiceControls');
            const textInputFallback = document.getElementById('textInputFallback');
            
            if (micButton) micButton.classList.remove('listening');
            if (voiceVisualizer) voiceVisualizer.style.display = 'none';
            if (voiceControls) voiceControls.style.display = 'none';
            if (textInputFallback) textInputFallback.style.display = 'block';
            
            // Stop voice visualization
            stopVoiceVisualization();
            
            // Add message about switching to text mode
            addAIMessage("Switched to text mode. Type your message in the text box below.");
            
            console.log('‚úÖ Switched to text mode successfully');
        }

        // ===================================================
        // üîò SMART BUTTON SYSTEM
        // ===================================================
        function updateSmartButton(shouldShow, buttonText, actionType) {
            const smartButton = document.getElementById('smartButton');
            
            if (!smartButton) return;
            
            if (shouldShow) {
                smartButton.style.display = 'block';
                smartButton.textContent = buttonText;
                smartButton.setAttribute('data-action', actionType);
                
                // Add visual emphasis for important CTAs
                if (actionType === 'interview' || actionType === 'connect_bruce') {
                    smartButton.classList.add('pulse-animation');
                } else {
                    smartButton.classList.remove('pulse-animation');
                }
            } else {
                smartButton.style.display = 'none';
                smartButton.textContent = 'AI Smart Button';
                smartButton.removeAttribute('data-action');
                smartButton.classList.remove('pulse-animation');
            }
        }

        function handleSmartButtonClick() {
            const smartButton = document.getElementById('smartButton');
            const actionType = smartButton ? smartButton.getAttribute('data-action') : 'default';
            
            console.log('Smart button clicked, action:', actionType);
            
            switch(actionType) {
                case 'valuation':
                    simulateUserMessage("Yes, I'm interested in a valuation");
                    break;
                    
                case 'buying':
                    simulateUserMessage("Yes, show me available practices");
                    break;
                    
                case 'schedule_today':
                    simulateUserMessage("Today works for me");
                    break;
                    
                case 'schedule_tomorrow':
                    simulateUserMessage("Tomorrow works better");
                    break;
                    
                case 'connect_bruce':
                    simulateUserMessage("I'd like to connect with Bruce");
                    break;
                    
                default:
                    console.log('Smart button clicked - no specific action defined');
                    simulateUserMessage("I need help with my practice");
            }
        }

        function simulateUserMessage(message) {
            console.log('Simulating user message:', message);
            
            // Create user bubble
            const chatMessages = document.getElementById('chatMessages');
            const userBubble = document.createElement('div');
            userBubble.className = 'message user-message';
            userBubble.textContent = message;
            
            chatMessages.appendChild(userBubble);
            scrollChatToBottom();
            
            // Process the message
            processUserResponse(message);
        }

        // ===================================================
        // ‚ö° QUICK QUESTIONS SYSTEM
        // ===================================================
        function askQuickQuestion(questionText) {
            console.log('üéØ Quick question clicked:', questionText);
            
            if (isSpeaking) {
                console.log('Ignoring quick question - system busy');
                return;
            }
            
            addUserMessage(questionText);
            
            setTimeout(() => {
                const response = getAIResponse(questionText);
                addAIMessage(response);
                speakResponse(response);
            }, 800);
        }

        // ===================================================
        // üìä VOICE VISUALIZATION SYSTEM
        // ===================================================
        function startVoiceVisualization() {
            const visualizerBars = document.getElementById('visualizerBars');
            if (!visualizerBars) return;
            
            // Clear any existing interval
            stopVoiceVisualization();
            
            // Create bars if they don't exist
            if (visualizerBars.children.length === 0) {
                for (let i = 0; i < 7; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    visualizerBars.appendChild(bar);
                }
            }
            
            // Show visualizer
            const voiceVisualizer = document.getElementById('voiceVisualizer');
            if (voiceVisualizer) voiceVisualizer.style.display = 'block';
            
            // Animate the bars
            visualizerInterval = setInterval(() => {
                const bars = visualizerBars.children;
                for (let i = 0; i < bars.length; i++) {
                    // Random height between 10% and 90%
                    const height = 10 + Math.random() * 80;
                    bars[i].style.height = `${height}%`;
                }
            }, 100);
        }

        function stopVoiceVisualization() {
            if (visualizerInterval) {
                clearInterval(visualizerInterval);
                visualizerInterval = null;
            }
            
            const voiceVisualizer = document.getElementById('voiceVisualizer');
            if (voiceVisualizer) voiceVisualizer.style.display = 'none';
        }

        // ===================================================
        // üöÄ INITIALIZATION SYSTEM
        // ===================================================
        function initializeChatInterface() {
            // Clear loading message
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Add welcome message
            addAIMessage("Welcome to Voice Chat! Please allow microphone access to use voice features.");
            
            // Set up event listeners
            const micButton = document.getElementById('micButton');
            const sendBtn = document.getElementById('sendBtn');
            const userInput = document.getElementById('userInput');
            const smartButton = document.getElementById('smartButton');
            const enableMicBtn = document.getElementById('enableMic');
            
            if (enableMicBtn) {
                enableMicBtn.addEventListener('click', requestMicrophoneAccess);
            }
            
            if (micButton) {
                micButton.addEventListener('click', function() {
                    if (!isAudioMode) {
                        requestMicrophoneAccess();
                    } else if (!isListening) {
                        startListening();
                    } else {
                        stopListening();
                    }
                });
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (userInput) {
                userInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            if (smartButton) {
                smartButton.addEventListener('click', handleSmartButtonClick);
            }
            
            console.log('‚úÖ Chat interface initialized');
        }

        // ===================================================
        // üåê GLOBAL FUNCTIONS
        // ===================================================
        window.askQuickQuestion = askQuickQuestion;
        window.handleSmartButtonClick = handleSmartButtonClick;

        // ===================================================
        // üéØ INITIALIZE THE APPLICATION
        // ===================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Voice Chat System...');
            
            initializeChatInterface();
            
            // Auto-focus on input field
            const userInput = document.getElementById('userInput');
            if (userInput) userInput.focus();
        });
    </script>
</body>
</html>